[{"content":" HTTPS å•åŒå‘è®¤è¯åŠè¯ä¹¦ç›¸å…³ ä¸€äº›å¸¸è¯† CA è¯ä¹¦å’Œç§é’¥ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯SSLè¯ä¹¦ è¯ä¹¦æ ¼å¼ è¯ä¹¦è¯·æ±‚ è¯ä¹¦é“¾ HTTPS å•å‘è®¤è¯ï¼ˆSSL/TLS) HTTPS åŒå‘è®¤è¯ï¼ˆmTLSï¼‰ è‡ªç­¾åè¯ä¹¦ mTLS å®æˆ˜ è‡ªç­¾åæ ¹è¯ä¹¦ CA è‡ªç­¾åæœåŠ¡ç«¯è¯ä¹¦ è‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦ éªŒè¯ å¸¦è¯ä¹¦çš„æˆåŠŸè°ƒç”¨ ä¸å¸¦è¯ä¹¦çš„è°ƒç”¨ Reference HTTPS å•åŒå‘è®¤è¯åŠè¯ä¹¦ç›¸å…³ ä¸€äº›å¸¸è¯† CA è¯ä¹¦å’Œç§é’¥ CAï¼ˆCertificate Authorityï¼‰è¯ä¹¦ï¼šç”±æƒå¨è®¤è¯æœºæ„ï¼ˆCAï¼‰ç­¾å‘çš„æ•°å­—è¯ä¹¦ï¼Œç”¨äºè¯æ˜è¯ä¹¦æŒæœ‰è€…çš„èº«ä»½ã€‚CAè¯ä¹¦å¯ä»¥è‡ªç­¾åï¼Œä¹Ÿå¯ä»¥ç”±æ›´ä¸Šçº§çš„CAç­¾åã€‚æ ¹CAè¯ä¹¦é€šå¸¸æ˜¯è‡ªç­¾åçš„ï¼Œç”¨ root.key ç­¾åä¸€ä¸ª root.crt æ ¹è¯ä¹¦ã€‚CA è¯ä¹¦å¯èƒ½æ˜¯ä¸€ä¸ªæ ¹è¯ä¹¦ï¼ˆroot.crtï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªä¸­é—´è¯ä¹¦ï¼ˆå­ CA è¯ä¹¦ï¼‰ã€‚ CA ç§é’¥ï¼šç”¨äºç­¾å‘å’ŒéªŒè¯å…¶ä»–è¯ä¹¦ã€‚CAç§é’¥éå¸¸é‡è¦ï¼Œå¿…é¡»å¦¥å–„ä¿ç®¡ï¼Œç¡®ä¿ä¸ä¼šæ³„éœ²ã€‚ å…¬é’¥æ˜¯å­˜å‚¨åœ¨è¯ä¹¦é‡Œçš„ï¼Œkey æ˜¯ç§é’¥ï¼Œç”¨äºç­¾å‘è¯ä¹¦ å¸¸è§ CA æœºæ„ï¼Œå¯ä»¥ç­¾å‘æœåŠ¡ç«¯ SSL è¯ä¹¦\nLet\u0026rsquo;s Encryptï¼šLet\u0026rsquo;s Encrypt æ˜¯ä¸€ä¸ªå…è´¹çš„ã€è‡ªåŠ¨åŒ–çš„è¯ä¹¦é¢å‘æœºæ„ï¼Œè‡´åŠ›äºæ¨åŠ¨å…¨çƒç½‘ç«™åŠ å¯†åŒ–ã€‚ DigiCertï¼šDigiCert æ˜¯ä¸€å®¶çŸ¥åçš„å•†ä¸šè¯ä¹¦é¢å‘æœºæ„ï¼Œæä¾›å„ç§ SSL/TLS è¯ä¹¦å’Œæ•°å­—è¯ä¹¦è§£å†³æ–¹æ¡ˆã€‚ Sectigoï¼ˆåŸåComodoï¼‰ï¼šSectigo æ˜¯ä¸€å®¶å…¨çƒé¢†å…ˆçš„æ•°å­—è¯ä¹¦é¢å‘æœºæ„ï¼Œæä¾› SSL è¯ä¹¦ã€ä»£ç ç­¾åè¯ä¹¦ç­‰å®‰å…¨è§£å†³æ–¹æ¡ˆã€‚ GlobalSignï¼šGlobalSign æ˜¯ä¸€å®¶å…¨çƒæ€§çš„æ•°å­—è¯ä¹¦é¢å‘æœºæ„ï¼Œæä¾› SSL è¯ä¹¦ã€ä»£ç ç­¾åè¯ä¹¦ã€èº«ä»½éªŒè¯ç­‰æœåŠ¡ã€‚ GoDaddyï¼šGoDaddy æ˜¯ä¸€å®¶çŸ¥åçš„åŸŸåæ³¨å†Œå•†ï¼Œä¹Ÿæä¾› SSL è¯ä¹¦å’Œå…¶ä»–ç½‘ç»œå®‰å…¨æœåŠ¡ã€‚ Entrust Datacardï¼šEntrust Datacard æ˜¯ä¸€å®¶æä¾›æ•°å­—è¯ä¹¦ã€èº«ä»½éªŒè¯å’ŒåŠ å¯†è§£å†³æ–¹æ¡ˆçš„é¢†å…ˆä¾›åº”å•†ã€‚ æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯SSLè¯ä¹¦ æœåŠ¡ç«¯SSLè¯ä¹¦ï¼šå®‰è£…åœ¨æœåŠ¡å™¨ä¸Šçš„æ•°å­—è¯ä¹¦ï¼Œç”¨äºåŠ å¯†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§å’Œå®Œæ•´æ€§ã€‚é€šå¸¸ç”± CA ç­¾å‘ï¼ŒåŒ…å«æœåŠ¡å™¨çš„å…¬é’¥ä¿¡æ¯ã€‚ï¼ˆserver.crt å®¢æˆ·ç«¯SSLè¯ä¹¦ï¼šå®‰è£…åœ¨å®¢æˆ·ç«¯ä¸Šçš„æ•°å­—è¯ä¹¦ï¼Œç”¨äºéªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½ï¼Œé€šå¸¸åœ¨åŒå‘è®¤è¯ï¼ˆmTLSï¼‰ä¸­ä½¿ç”¨ã€‚(client.crt è¯ä¹¦æ ¼å¼ X.509 X.509 æ ¼å¼è¯ä¹¦æ˜¯ä¸€ç§æ ‡å‡†çš„å…¬é’¥è¯ä¹¦æ ¼å¼ï¼ŒX.509 è¯ä¹¦çš„ä¸»è¦ç‰¹ç‚¹å’Œç»„æˆéƒ¨åˆ†åŒ…æ‹¬ï¼š\næ ‡å‡†åŒ–æ ¼å¼ï¼šX.509 å®šä¹‰äº†ä¸€ä¸ªç»“æ„åŒ–çš„è¯ä¹¦æ ¼å¼ï¼Œç¡®ä¿äº†ä¸åŒç³»ç»Ÿä¹‹é—´èƒ½å¤Ÿäº’æ“ä½œå’Œç†è§£ã€‚ å…¬é’¥ä¿¡æ¯ï¼šè¯ä¹¦åŒ…å«äº†è¯ä¹¦æŒæœ‰è€…çš„å…¬é’¥ï¼Œè¿™æ˜¯ç”¨äºåŠ å¯†æ•°æ®æˆ–éªŒè¯æ•°å­—ç­¾åçš„å…³é”®éƒ¨åˆ†ã€‚ èº«ä»½ä¿¡æ¯ï¼šè¯ä¹¦è¿˜åŒ…æ‹¬è¯ä¹¦æŒæœ‰è€…çš„èº«ä»½ä¿¡æ¯ï¼Œå¦‚ç»„ç»‡åç§°ã€ç»„ç»‡å•å…ƒã€å›½å®¶/åœ°åŒºç­‰ã€‚è¿™äº›ä¿¡æ¯å¸®åŠ©éªŒè¯è¯ä¹¦æŒæœ‰è€…çš„èº«ä»½ã€‚ ç­¾åï¼šè¯ä¹¦ç”±è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰è¿›è¡Œæ•°å­—ç­¾åï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚è¿™æ„å‘³ç€å¦‚æœè¯ä¹¦è¢«ç¯¡æ”¹ï¼Œç­¾åå°†ä¸å†æœ‰æ•ˆã€‚ æœ‰æ•ˆæœŸï¼šæ¯ä¸ª X.509 è¯ä¹¦éƒ½æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„æ—¶é—´èŒƒå›´ï¼Œç”±â€œå¼€å§‹æ—¥æœŸâ€å’Œâ€œç»“æŸæ—¥æœŸâ€å®šä¹‰ã€‚è¿™ç¡®ä¿äº†è¯ä¹¦çš„æ—¶æ•ˆæ€§å’Œå®šæœŸæ›´æ–°éœ€æ±‚ã€‚ è¯ä¹¦é“¾å’Œä¿¡ä»»ï¼šX.509 è¯ä¹¦é€šå¸¸æ˜¯è¯ä¹¦é“¾çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­æ¯ä¸ªè¯ä¹¦éƒ½ç”±ä¸Šä¸€çº§è¯ä¹¦é¢å‘æœºæ„ç­¾åï¼Œæœ€ç»ˆè¿½æº¯åˆ°ä¸€ä¸ªå—ä¿¡ä»»çš„æ ¹è¯ä¹¦ã€‚è¿™ç§ç»“æ„å»ºç«‹äº†ä¿¡ä»»é“¾ï¼Œä½¿å¾—ç»ˆç«¯ç”¨æˆ·å¯ä»¥éªŒè¯è¯ä¹¦çš„åˆæ³•æ€§ã€‚ æ‰©å±•æ€§ï¼šX.509 è¯ä¹¦æ”¯æŒæ‰©å±•å­—æ®µï¼Œå…è®¸æ·»åŠ é¢å¤–ä¿¡æ¯ï¼Œå¦‚å¯†é’¥ç”¨é€”ã€è¯ä¹¦ç­–ç•¥ç­‰ï¼Œä»¥æ»¡è¶³ä¸åŒåº”ç”¨åœºæ™¯çš„éœ€æ±‚ .crt åç¼€è¯ä¹¦ï¼Œå¯èƒ½æ˜¯ PEM ç¼–ç ï¼Œä¹Ÿå¯èƒ½æ˜¯ DER ç¼–ç \nPEM (Privacy Enhanced Mail) PEM æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„ç¼–ç æ ¼å¼ï¼Œç‰¹åˆ«æ˜¯å®‰å…¨é¢†åŸŸçš„æ•°æ®ï¼Œå¦‚è¯ä¹¦ã€å¯†é’¥ç­‰ã€‚PEM æ ¼å¼ä½¿ç”¨ Base64 ç¼–ç çš„ ASCII æ–‡æœ¬è¡¨ç¤ºï¼Œå¹¶å¸¦æœ‰ \u0026quot;-----BEGIN CERTIFICATE-----\u0026quot; å’Œ \u0026quot;-----END CERTIFICATE-----\u0026quot; çš„è¾¹ç•Œæ ‡è®°ã€‚å¯ä»¥ä»¥ ASCII çš„æ ¼å¼å­˜å‚¨ X.509 æ ¼å¼çš„è¯ä¹¦ crtã€‚\nè¯ä¹¦å¯ä»¥å­˜å‚¨å…¬é’¥ã€ç§é’¥ã€è¯ä¹¦ã€è¯ä¹¦é“¾ã€è¯ä¹¦è¯·æ±‚\nå…¬é’¥ï¼šé€šå¸¸ä»¥ â€œ-----BEGIN PUBLIC KEY-----â€ å’Œ â€œ-----END PUBLIC KEY-----â€ ä¸ºè¾¹ç•Œ\nç§é’¥ï¼šé€šå¸¸ä»¥ â€œ-----BEGIN PRIVATE KEY-----â€ å’Œ â€œ-----END PRIVATE KEY-----â€ ä¸ºè¾¹ç•Œï¼Œæˆ–è€…å¯¹äºæŸäº›ç±»å‹çš„ç§é’¥ï¼ˆå¦‚RSAç§é’¥ï¼‰ï¼Œå¯èƒ½æ˜¯ â€œ-----BEGIN RSA PRIVATE KEY-----â€ å’Œ â€œ-----END RSA PRIVATE KEY-----â€\nè¯ä¹¦ï¼šåŒ…æ‹¬æœåŠ¡å™¨è¯ä¹¦ã€ä¸­é—´è¯ä¹¦ç­‰ï¼Œé€šå¸¸ä»¥ â€œ-----BEGIN CERTIFICATE-----â€ å’Œ â€œ-----END CERTIFICATE-----â€ ä¸ºè¾¹ç•Œ\nè¯ä¹¦è¯·æ±‚ï¼ˆå¦‚CSRï¼ŒCertificate Signing Requestï¼‰ï¼šé€šå¸¸ä»¥ â€œ-----BEGIN CERTIFICATE REQUEST-----â€ å’Œ â€œ-----END CERTIFICATE REQUEST-----â€ ä¸ºè¾¹ç•Œã€‚\n1 2 3 4 # æŸ¥çœ‹ PEM è¯ä¹¦ä¿¡æ¯ openssl x509 -in certificate.pem -text -noout # PEM è½¬ DER openssl x509 -in cert.crt -outform der -out cert.der DER (Distinguished Encoding Rules) X.509 è¯ä¹¦åœ¨äºŒè¿›åˆ¶å½¢å¼ä¸‹é€šå¸¸ä½¿ç”¨ DER æ ¼å¼ã€‚è™½ç„¶ DER æœ¬èº«ä¸æ˜¯è¯ä¹¦æ ¼å¼ï¼Œä½†å®ƒæ˜¯ X.509 è¯ä¹¦ äºŒè¿›åˆ¶ç¼–ç  çš„åŸºç¡€ã€‚å­˜è¯ä¹¦ï¼Œæ²¡æœ‰ç§é’¥\n1 2 3 4 # æŸ¥çœ‹ DER è¯ä¹¦ä¿¡æ¯ openssl x509 -in certificate.der -inform der -text -noout # DER è½¬ PEM openssl x509 -in cert.crt -inform der -outform pem -out cert.pem PFX/PKCS12ï¼ˆPublic-Key Cryptography Standards #12ï¼‰ å¸¸ç”¨äºå­˜å‚¨ç§é’¥å’Œç›¸å…³çš„å…¬é’¥è¯ä¹¦é“¾ï¼Œä»¥ .pfx æˆ– .p12 ä¸ºæ–‡ä»¶æ‰©å±•åã€‚è¿™ç§æ ¼å¼å¯ä»¥è½¬æ¢ä¸º PEM æ ¼å¼ï¼Œä»è€Œæå–å‡ºç§é’¥å’Œè¯ä¹¦ã€‚é€šå¸¸åŒ…å«ç§é’¥ã€è¯ä¹¦å’Œè¯ä¹¦é“¾çš„ç»„åˆ\nPKCS12 å¯ä»¥åŒ…å« å…¬é’¥ã€ç§é’¥ã€è¯ä¹¦å’Œè¯ä¹¦é“¾ ï¼Œå¹¶ä¸”æœ‰ å¯†ç ä¿æŠ¤ ï¼Œä¸€èˆ¬ä¾¿äºä¸åŒå¹³å°ä¼ è¾“ï¼Œå¸¸ç”¨äºå®¢æˆ·ç«¯è¯ä¹¦ï¼ˆclient.crt â†’ client.p12\n1 2 3 4 # æŸ¥çœ‹ p12 è¯ä¹¦ä¿¡æ¯ openssl pkcs12 -info -in your_certificate.p12 # p12 è½¬ pem openssl pkcs12 -in your_certificate.p12 -nocerts -out private_key.pem JKSï¼ˆJava KeyStoreï¼‰ JKS æ˜¯ Java ä¸­ç”¨äºå­˜å‚¨å¯†é’¥å’Œè¯ä¹¦çš„ä¸“æœ‰æ ¼å¼ï¼ŒäºŒè¿›åˆ¶æ ¼å¼ã€‚JKS æ–‡ä»¶é€šå¸¸ä»¥ .jks ä¸ºæ–‡ä»¶æ‰©å±•åã€‚åœ¨ Java åº”ç”¨ç¨‹åºä¸­ç®¡ç†å¯†é’¥å’Œè¯ä¹¦ï¼ŒåŒ…æ‹¬ç§é’¥ã€è¯ä¹¦ã€è¯ä¹¦é“¾ç­‰ä¿¡æ¯ã€‚JKS æ–‡ä»¶é€šå¸¸éœ€è¦å¯†ç æ¥ä¿æŠ¤å­˜å‚¨åœ¨å…¶ä¸­çš„å¯†é’¥å’Œè¯ä¹¦ã€‚\nç”Ÿæˆå’Œè½¬æ¢éœ€è¦ç”¨åˆ° Java keytool\nè¯ä¹¦è¯·æ±‚ CSRï¼ˆCertificate Signing Requestï¼‰æ˜¯ä¸€ç§åŒ…å«æœ‰å…³ç»„ç»‡æˆ–ä¸ªäººä¿¡æ¯çš„åŠ å¯†æ–‡æœ¬ï¼Œç”¨äºå‘è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ç”³è¯·æ•°å­—è¯ä¹¦ã€‚CSRåŒ…å«äº†å°†åŒ…å«åœ¨æ•°å­—è¯ä¹¦ä¸­çš„ å…¬é’¥ï¼Œä»¥åŠä¸è¯¥å…¬é’¥ç›¸å…³è”çš„ç»„ç»‡ä¿¡æ¯ï¼Œå¦‚ç»„ç»‡åç§°ã€åŸŸåç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # å…ˆåˆ›å»ºä¸€ä¸ªç§é’¥ key openssl genrsa -out root.key 4096 # å†æ ¹æ® key ç”Ÿæˆä¸€ä¸ªè¯ä¹¦è¯·æ±‚ openssl req -new -out root.csr -key root.key # ä¸‹é¢æ˜¯æç¤ºå‡ºæ¥éœ€è¦å¡«å†™åˆ° csr çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›½å®¶ã€çœã€åŸå¸‚ã€å…¬å¸ã€å•ä½ã€åŸŸåã€å¯†ç ç­‰ä¿¡æ¯ Country Name (2 letter code) [XX]:cn State or Province Name (full name) []:bj Locality Name (eg, city) [Default City]:bj Organization Name (eg, company) [Default Company Ltd]:alibaba Organizational Unit Name (eg, section) []:test Common Name (eg, your name or your servers hostname) []:root Email Address []:a.alibaba.com A challenge password []: An optional company name []: # ç”¨ key å’Œ csr ç”Ÿæˆ 10 å¹´æœŸé™çš„æ ¹è¯ä¹¦ root.crt openssl x509 -req -in root.csr -out root.crt -signkey root.key -CAcreateserial -days 3650 ç”Ÿæˆçš„ root.csr è¯ä¹¦è¯·æ±‚ï¼Œä¸€æ–¹é¢åŒ…å«å…¬å¸ä¿¡æ¯ï¼Œå¦ä¸€æ–¹é¢åŒ…å« key å¯¹åº”çš„å…¬é’¥ã€‚\nç”¨ key å’Œ csr å°±å¯ä»¥ç­¾å‘ä¸€ä¸ªè¯ä¹¦ root.crtã€‚å‡è®¾å…¬å¸ä¿¡æ¯ä¸æ”¹å˜ï¼Œkey ä¹Ÿæœªæ³„éœ²ï¼Œç”±äºå…¬ç§é’¥æ˜¯å¯¹åº”çš„ï¼Œç†è®ºä¸Šç­‰åˆ° root.crt è¿‡æœŸåï¼Œå¯ä»¥å†æ¬¡ç­¾å‘ä¸€ä¸ª root.crtï¼Œè¾¾åˆ°ç»­ç­¾çš„ç›®çš„ã€‚\nè¯ä¹¦é“¾ è¯ä¹¦é“¾æ˜¯æŒ‡ä»æ ¹è¯ä¹¦ï¼ˆRoot Certificateï¼‰å¼€å§‹ï¼Œé€šè¿‡ä¸­é—´è¯ä¹¦ï¼ˆIntermediate Certificateï¼‰é€çº§ç­¾å‘ï¼Œç›´åˆ°æœ€ç»ˆçš„ç»ˆç«¯ç”¨æˆ·è¯ä¹¦ï¼ˆEnd-Entity Certificateï¼‰\næ ¹è¯ä¹¦ï¼ˆRoot Certificateï¼‰ï¼šè‡ªç­¾åçš„è¯ä¹¦ï¼Œä½äºè¯ä¹¦é“¾çš„æœ€é¡¶ç«¯ã€‚æ ¹è¯ä¹¦ç”±æƒå¨è®¤è¯æœºæ„ï¼ˆCAï¼‰å‘è¡Œå¹¶ä¿å­˜åœ¨å—ä¿¡ä»»çš„å­˜å‚¨åŒºä¸­ã€‚ ä¸­é—´è¯ä¹¦ï¼ˆIntermediate Certificateï¼‰ï¼šç”±æ ¹è¯ä¹¦æˆ–å…¶ä»–ä¸­é—´è¯ä¹¦ç­¾å‘ï¼Œå½¢æˆè¯ä¹¦é“¾ã€‚ä¸­é—´è¯ä¹¦ç”¨äºç­¾å‘æ›´ä¸‹çº§çš„è¯ä¹¦ã€‚ ç»ˆç«¯ç”¨æˆ·è¯ä¹¦ï¼ˆEnd-Entity Certificateï¼‰ï¼šç”±æ ¹è¯ä¹¦æˆ–ä¸­é—´è¯ä¹¦ç­¾å‘ï¼Œæœ€ç»ˆç”¨äºæœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯ã€‚ root.crt â†’ intermediate1.crt â†’ intermediate2.crt â†’ server.crt\nä»¥ä¸Šè¿‡ç¨‹ root.crt æ˜¯æ ¹è¯ä¹¦ï¼Œä»¥ root.crt ä¸º CA ç­¾å‘ä¸­é—´è¯ä¹¦ intermediate1.crtï¼Œå†ç”¨ intermediate1.crt ä¸º CA ç­¾å‘ intermediate2.crt ä¸­é—´è¯ä¹¦ï¼Œæœ€å intermediate2.crt ç­¾å‘ç»ˆç«¯ç”¨æˆ·è¯ä¹¦ server.crt\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 openssl genrsa -out root.key 4096 # æ ¹ç§é’¥ # æ ¹è¯ä¹¦ openssl req -new -x509 -days 3650 -key root.key -out root.crt -subj \u0026#34;/CN=Root CA\u0026#34; openssl genrsa -out intermediate1.key 4096 # ä¸­é—´è¯ä¹¦ 1 ç§é’¥ # ä¸­é—´è¯ä¹¦è¯·æ±‚ 1 openssl req -new -key intermediate1.key -out intermediate1.csr -subj \u0026#34;/CN=Intermediate CA 1\u0026#34; # æ ¹è¯ä¹¦ç­¾å‘ä¸­é—´è¯ä¹¦ 1 openssl x509 -req -in intermediate1.csr -CA root.crt -CAkey root.key -CAcreateserial -out intermediate1.crt -days 3650 openssl genrsa -out intermediate2.key 4096 # ä¸­é—´è¯ä¹¦ 2 ç§é’¥ # ä¸­é—´è¯ä¹¦è¯·æ±‚ 2 openssl req -new -key intermediate2.key -out intermediate2.csr -subj \u0026#34;/CN=Intermediate CA 2\u0026#34; # ä¸­é—´è¯ä¹¦ 1 åš CA ç­¾å‘ä¸­é—´è¯ä¹¦ 2 openssl x509 -req -in intermediate2.csr -CA intermediate1.crt -CAkey intermediate1.key -CAcreateserial -out intermediate2.crt -days 3650 openssl genrsa -out server.key 4096 # ç»ˆç«¯ç”¨æˆ·è¯ä¹¦ç§é’¥ # ç»ˆç«¯ç”¨æˆ·è¯ä¹¦è¯·æ±‚ openssl req -new -key server.key -out server.csr -subj \u0026#34;/CN=server.example.com\u0026#34; # ä¸­é—´è¯ä¹¦ 2 åš CA ç­¾å‘ç»ˆç«¯ç”¨æˆ·è¯ä¹¦ openssl x509 -req -in server.csr -CA intermediate2.crt -CAkey intermediate2.key -CAcreateserial -out server.crt -days 365 æ ¹è¯ä¹¦ï¼ˆroot.crtï¼‰ï¼šé€šå¸¸ä¿å­˜åœ¨æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„å—ä¿¡ä»»è¯ä¹¦å­˜å‚¨ä¸­ã€‚ä½œä¸ºä¿¡ä»»é“¾çš„æ ¹ï¼Œå®¢æˆ·ç«¯æ— éœ€ç›´æ¥è®¿é—®å®ƒã€‚\nä¸­é—´è¯ä¹¦ä¸€ï¼ˆintermediate1.crtï¼‰å’Œä¸­é—´è¯ä¹¦äºŒï¼ˆintermediate2.crtï¼‰ï¼šä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œç”¨äºå»ºç«‹å®Œæ•´çš„è¯ä¹¦é“¾ã€‚å®¢æˆ·ç«¯ä¼šé€šè¿‡æœåŠ¡å™¨ä¼ é€’çš„è¯ä¹¦é“¾éªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„å¯ä¿¡åº¦ã€‚\nç»ˆç«¯ç”¨æˆ·è¯ä¹¦ï¼ˆserver.crtï¼‰å’Œç§é’¥ï¼ˆserver.keyï¼‰ï¼šå®‰è£…åœ¨æœåŠ¡å™¨ä¸Šï¼Œç”¨äºåŠ å¯†é€šä¿¡å’ŒéªŒè¯æœåŠ¡å™¨èº«ä»½ã€‚\nå®Œæ•´çš„è¯ä¹¦é“¾æ–‡ä»¶ï¼šæœåŠ¡å™¨éœ€è¦æä¾›ä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸­é—´è¯ä¹¦çš„æ–‡ä»¶ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥éªŒè¯è¯ä¹¦é“¾ã€‚å¯ä»¥å°†ä¸­é—´è¯ä¹¦å’Œç»ˆç«¯è¯ä¹¦åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œè¯ä¹¦é“¾çš„é¡ºåºæ˜¯ï¼šSSL è¯ä¹¦ â†’ ä¸­é—´è¯ä¹¦ â†’ æ ¹è¯ä¹¦ï¼Œä¾æ¬¡å‘ä¸Šæ¸¸ï¼Œä¸€èˆ¬å®¢æˆ·ç«¯ä¼šé»˜è®¤ä¿¡ä»»æ ¹è¯ä¹¦ï¼Œå¯ä»¥çœç•¥\n1 cat server.crt intermediate2.crt intermediate1.crt \u0026gt; fullchain.crt æœåŠ¡å™¨é…ç½®ç¤ºä¾‹ï¼ˆä»¥Nginxä¸ºä¾‹ï¼‰ï¼š\n1 2 3 4 5 6 7 server { listen 443 ssl; server_name example.com; ssl_certificate /path/to/fullchain.crt; ssl_certificate_key /path/to/server.key; } å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦é“¾ï¼š\nå®¢æˆ·ç«¯éªŒè¯ç»ˆç«¯ç”¨æˆ·è¯ä¹¦æ˜¯å¦ç”±ä¸­é—´è¯ä¹¦äºŒç­¾å‘ã€‚ å®¢æˆ·ç«¯éªŒè¯ä¸­é—´è¯ä¹¦äºŒæ˜¯å¦ç”±ä¸­é—´è¯ä¹¦ä¸€ç­¾å‘ã€‚ å®¢æˆ·ç«¯éªŒè¯ä¸­é—´è¯ä¹¦ä¸€æ˜¯å¦ç”±æ ¹è¯ä¹¦ç­¾å‘ã€‚ å®¢æˆ·ç«¯æ£€æŸ¥æ ¹è¯ä¹¦æ˜¯å¦åœ¨å—ä¿¡ä»»çš„æ ¹è¯ä¹¦åˆ—è¡¨ä¸­ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # éªŒè¯ä¸­é—´è¯ä¹¦ä¸€æ˜¯å¦ç”±æ ¹è¯ä¹¦ç­¾å‘ openssl verify -CAfile root.crt intermediate1.crt # intermediate1.crt: OK # æ¥ä¸‹æ¥ï¼ŒéªŒè¯ä¸­é—´è¯ä¹¦äºŒæ˜¯å¦ç”±ä¸­é—´è¯ä¹¦ä¸€ç­¾å‘ã€‚ # ä¸ºäº†éªŒè¯ä¸­é—´è¯ä¹¦äºŒï¼Œå…ˆåˆ›å»ºä¸€ä¸ªè¯ä¹¦é“¾æ–‡ä»¶ï¼ŒåŒ…å«æ ¹è¯ä¹¦å’Œä¸­é—´è¯ä¹¦ä¸€ã€‚ cat root.crt intermediate1.crt \u0026gt; chain1.pem openssl verify -CAfile chain1.pem intermediate2.crt # intermediate2.crt: OK # æœ€åï¼ŒéªŒè¯ç»ˆç«¯ç”¨æˆ·è¯ä¹¦æ˜¯å¦ç”±ä¸­é—´è¯ä¹¦äºŒç­¾å‘ã€‚ # åˆ›å»ºä¸€ä¸ªè¯ä¹¦é“¾æ–‡ä»¶ï¼ŒåŒ…å«æ ¹è¯ä¹¦å’Œæ‰€æœ‰ä¸­é—´è¯ä¹¦ã€‚ cat root.crt intermediate1.crt intermediate2.crt \u0026gt; chain2.pem openssl verify -CAfile chain2.pem server.crt # server.crt: OK # ä¸ºäº†å®Œæ•´éªŒè¯æ•´ä¸ªè¯ä¹¦é“¾ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯æ•´ä¸ªè¯ä¹¦é“¾æ–‡ä»¶ fullchain.crtï¼š cat server.crt intermediate2.crt intermediate1.crt \u0026gt; fullchain.crt openssl verify -CAfile root.crt fullchain.crt # fullchain.crt: OK HTTPS å•å‘è®¤è¯ï¼ˆSSL/TLS) å®¢æˆ·ç«¯å‘èµ·å»ºç«‹HTTPSè¿æ¥è¯·æ±‚ï¼Œå°†SSLåè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰å‘é€ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼› å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ˆå¯†é’¥ Rï¼‰ï¼Œç”¨åˆšæ‰å¾—åˆ°çš„æœåŠ¡å™¨å…¬é’¥å»åŠ å¯†è¿™ä¸ªéšæœºæ•°å½¢æˆå¯†æ–‡ï¼Œå‘é€ç»™æœåŠ¡ç«¯ï¼› æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥ï¼ˆserver.keyï¼‰å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥ R æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥ R è¿›è¡Œé€šä¿¡äº†ã€‚ æœåŠ¡ç«¯éƒ¨ç½²æ—¶ï¼Œå°† server.crt å’Œ server.key ä¸Šä¼ è‡³æœåŠ¡å™¨å³å¯ã€‚å¦‚æœæœåŠ¡ç«¯ç”¨äº‘æœåŠ¡ LoadBalancerï¼Œåˆ™å°†ä¸¤ä¸ªæ–‡ä»¶ä¸Šä¼ è‡³ LB ç»‘å®šçš„åœ°æ–¹ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘ CLB ç•Œé¢æœ‰è¯ä¹¦ç®¡ç†ï¼ŒAWS æœ‰ ACMï¼ˆAWS Certificate Managerï¼‰ä¸“é—¨ç®¡ç†è¯ä¹¦ç­‰ï¼›å¦‚æœæœåŠ¡ç«¯ç”¨ K8S Ingress é…ç½® SSLï¼Œåˆ™å°†ä¸¤ä¸ªæ–‡ä»¶ base64 åˆ° secretï¼Œå†å°† secret é…ç½®åˆ° ingress å®ç° SSL å•å‘è®¤è¯ã€‚å¦‚æœç”¨ Nginxï¼ŒApache ç­‰æœåŠ¡å™¨ï¼Œåˆ™æ‰¾åˆ°å¯¹åº”çš„æ–¹å¼ä¸Šä¼ è¯ä¹¦å³å¯ã€‚\nkey ç§é’¥ç”¨äºè§£å¯†å®¢æˆ·ç«¯å…¬é’¥åŠ å¯†çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥åœ¨æœåŠ¡ç«¯ç”Ÿæˆç­¾åã€‚crt è¯ä¹¦é…åˆå®¢æˆ·ç«¯å·²ç»ä¿¡ä»»çš„ CAï¼ŒéªŒè¯æœåŠ¡ç«¯çš„èº«ä»½ï¼ˆcrt å¸¦æœ‰æœåŠ¡ç«¯çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›½å®¶ã€åŸå¸‚ã€å…¬å¸ã€åŸŸåã€è¯ä¹¦èµ·å§‹å’Œè¿‡æœŸæ—¶é—´ç­‰ï¼›\nä¸€èˆ¬å…¬ç½‘ç¯å¢ƒï¼Œå®¢æˆ·ç«¯é»˜è®¤åœ¨æœ¬æœºéƒ½ä¼šå®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œé»˜è®¤ä¿¡ä»»ä¸€äº› CAï¼Œä¾‹å¦‚å¾®è½¯ç³»ç»Ÿ IIS ä¸“é—¨ç®¡ç†è¯ä¹¦ï¼Œæµè§ˆå™¨è‡ªåŠ¨è¯»å–ï¼Œç”¨æˆ·æ— æ„Ÿï¼›\nHTTPS åŒå‘è®¤è¯ï¼ˆmTLSï¼‰ å®¢æˆ·ç«¯å‘èµ·å»ºç«‹ HTTPS è¿æ¥è¯·æ±‚ï¼Œå°† SSL åè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ï¼› æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰å‘é€ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼› å®¢æˆ·ç«¯å°†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼ˆclient.crtï¼‰å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡å™¨ç«¯ä½¿ç”¨æ ¹è¯ä¹¦ï¼ˆroot.crtï¼‰è§£å¯†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼Œæ‹¿åˆ°å®¢æˆ·ç«¯å…¬é’¥ï¼› å®¢æˆ·ç«¯å‘é€è‡ªå·±æ”¯æŒçš„åŠ å¯†æ–¹æ¡ˆç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡å™¨ç«¯æ ¹æ®è‡ªå·±å’Œå®¢æˆ·ç«¯çš„èƒ½åŠ›ï¼Œé€‰æ‹©ä¸€ä¸ªåŒæ–¹éƒ½èƒ½æ¥å—çš„åŠ å¯†æ–¹æ¡ˆï¼Œä½¿ç”¨å®¢æˆ·ç«¯çš„å…¬é’¥åŠ å¯†åå‘é€ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†åŠ å¯†æ–¹æ¡ˆï¼Œç”Ÿæˆä¸€ä¸ªéšæœºæ•° Rï¼Œä½¿ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥ R æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥ R è¿›è¡Œé€šä¿¡äº†ã€‚ è¯ä¹¦å‡†å¤‡ï¼š\næœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼šserver.crt æœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ï¼šserver.key æ ¹è¯ä¹¦ï¼šroot.crt å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼šclient.crt å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶ï¼šclient.key å®¢æˆ·ç«¯é›†æˆè¯ä¹¦ï¼ˆåŒ…æ‹¬å…¬é’¥å’Œç§é’¥ï¼Œç”¨äºæµè§ˆå™¨è®¿é—®åœºæ™¯ï¼‰ï¼šclient.p12 æ‰€æœ‰è¯ä¹¦éƒ½å¯ä»¥æ‰¾ CA æœºæ„ç­¾å‘ï¼Œå¦‚æœå†…ç½‘ä½¿ç”¨ï¼Œéå…¬ä¼—ï¼Œåˆ™å¯ä»¥è‡ªå»º PKIï¼ˆPublic Key Infrastructureï¼‰ ç³»ç»Ÿè‡ªç­¾å‘ã€‚\næœåŠ¡å™¨é™¤äº†å•å‘è®¤è¯æ­¥éª¤é‡Œï¼Œä¸Šä¼  server.crt å’Œ server.key ä¸¤ä¸ªæ–‡ä»¶å¤–ï¼Œè¿˜éœ€è¦é¢å¤–æ·»åŠ  CA è¯ä¹¦ root.crtï¼ˆå‡è®¾ CA è¯ä¹¦å°±æ˜¯æ ¹è¯ä¹¦ï¼Œä¸æ˜¯å­ CA è¯ä¹¦ï¼Œå¦åˆ™éœ€è¦ä¸Šä¼ æ•´ä¸ªè¯ä¹¦é“¾ï¼‰ï¼Œè¿™ä¸ª client-CAï¼ˆroot.crt) è¯ä¹¦ç›¸å½“äºæœåŠ¡ç«¯ä¹Ÿæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œéœ€è¦æå‰ä¿¡ä»»ä¸€ä¸ªç­¾å‘ client.crt çš„ CA è¯ä¹¦ï¼Œä¾¿äºå®¢æˆ·ç«¯å‘é€å¸¦å®¢æˆ·ç«¯å…¬é’¥çš„ client.crt æ—¶ï¼ŒéªŒæ˜å®¢æˆ·ç«¯èº«ä»½ï¼Œå®ç°åŒå‘è®¤è¯ï¼ˆå³é¢å¤–å¢åŠ å®¢æˆ·ç«¯çš„èº«ä»½éªŒè¯ï¼‰ã€‚\nå› æ­¤å®¢æˆ·ç«¯æœ¬åœ°é™¤äº†å·²ç»ä¿¡ä»»ç­¾å‘ server.crt çš„ CA è¯ä¹¦ï¼Œä¹Ÿéœ€è¦ä¸Šä¼  client.crt å’Œ client.keyï¼Œå°±åƒæœåŠ¡ç«¯ä¸€æ ·ï¼Œä¸ºäº†å¯ä»¥å®‰è£…æµè§ˆå™¨ï¼Œè¿˜éœ€è¦å°† client.crt è½¬ä¸º client.p12 ä¾¿äºå®‰è£…ã€‚\nè‡ªç­¾åè¯ä¹¦ mTLS å®æˆ˜ æ‰¾ä¸€å°æœºå™¨æœ‰ openssl çš„ linux æœºå™¨æ¨¡æ‹Ÿè‡ªç­¾å\nè‡ªç­¾åæ ¹è¯ä¹¦ CA ï¼ˆ1ï¼‰åˆ›å»ºæ ¹è¯ä¹¦ç§é’¥ï¼š\n1 openssl genrsa -out root.key 1024 ï¼ˆ2ï¼‰åˆ›å»ºæ ¹è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼š\n1 openssl req -new -out root.csr -key root.key åç»­å‚æ•°è¯·è‡ªè¡Œå¡«å†™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š\næ³¨æ„ï¼šCA è¯ä¹¦ Common Name éœ€è¦ä¿è¯å”¯ä¸€æ€§ï¼Œä¸è¦ä¸æœåŠ¡ç«¯è¯ä¹¦æˆ–è€…å®¢æˆ·ç«¯è¯ä¹¦çš„ Common Name ç›¸åŒã€‚\n1 2 3 4 5 6 7 8 9 Country Name (2 letter code) [XX]:cn State or Province Name (full name) []:bj Locality Name (eg, city) [Default City]:bj Organization Name (eg, company) [Default Company Ltd]:alibaba Organizational Unit Name (eg, section) []:test Common Name (eg, your name or your servers hostname) []:root Email Address []:a.alibaba.com A challenge password []: An optional company name []: ï¼ˆ3ï¼‰åˆ›å»ºæ ¹è¯ä¹¦ï¼š\n1 openssl x509 -req -in root.csr -out root.crt -signkey root.key -CAcreateserial -days 3650 åœ¨åˆ›å»ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸‰ç‚¹ï¼Œä¸‹é¢ç”ŸæˆæœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶å‡è¦æ³¨æ„è¿™ä¸‰ç‚¹ï¼š æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å°±å¯ä»¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„è¯ä¹¦è¿™ä¸ªå­—æ®µéœ€è¦å¡«å†™åŸŸåï¼Œä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹è¯ä¹¦çš„è¿™ä¸ªå­—æ®µå’Œå®¢æˆ·ç«¯è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ ·ï¼› å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼Œæ ¹è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´æœ€åçš„å¯†ç å¯ä»¥ç›´æ¥å›è½¦è·³è¿‡ã€‚\nç»è¿‡ä¸Šé¢ä¸‰ä¸ªå‘½ä»¤è¡Œï¼Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—åˆ°ä¸€ä¸ªç­¾åæœ‰æ•ˆæœŸä¸º 10 å¹´çš„æ ¹è¯ä¹¦ root.crtï¼Œåé¢æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªæ ¹è¯ä¹¦å»é¢å‘æœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚\nè‡ªç­¾åæœåŠ¡ç«¯è¯ä¹¦ ï¼ˆ1ï¼‰ç”ŸæˆæœåŠ¡å™¨ç«¯è¯ä¹¦ç§é’¥ï¼š\n1 openssl genrsa -out server.key 1024 ï¼ˆ2ï¼‰ ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œè¿‡ç¨‹å’Œæ³¨æ„äº‹é¡¹å‚è€ƒæ ¹è¯ä¹¦ï¼Œæœ¬èŠ‚ä¸è¯¦è¿°ï¼š\n1 openssl req -new -out server.csr -key server.key ï¼ˆ3ï¼‰ ç”ŸæˆæœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦\n1 openssl x509 -req -in server.csr -out server.crt -signkey server.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650 ç»è¿‡ä¸Šé¢çš„ä¸‰ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š\nserver.keyï¼šæœåŠ¡å™¨ç«¯çš„å¯†é’¥æ–‡ä»¶ server.crtï¼šæœ‰æ•ˆæœŸåå¹´çš„æœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼Œä½¿ç”¨æ ¹è¯ä¹¦å’ŒæœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ä¸€èµ·ç”Ÿæˆ\nè‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦ ï¼ˆ1ï¼‰ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦å¯†é’¥ï¼š\n1 2 openssl genrsa -out client.key 1024 openssl genrsa -out client2.key 1024 ï¼ˆ2ï¼‰ ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œè¿‡ç¨‹å’Œæ³¨æ„äº‹é¡¹å‚è€ƒæ ¹è¯ä¹¦ï¼Œæœ¬èŠ‚ä¸è¯¦è¿°ï¼š\n1 2 openssl req -new -out client.csr -key client.key openssl req -new -out client2.csr -key client2.key ï¼ˆ3ï¼‰ ç”Ÿå®¢æˆ·ç«¯è¯ä¹¦\n1 2 openssl x509 -req -in client.csr -out client.crt -signkey client.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650 openssl x509 -req -in client2.csr -out client2.crt -signkey client2.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650 ï¼ˆ4ï¼‰ ç”Ÿå®¢æˆ·ç«¯p12æ ¼å¼è¯ä¹¦ï¼Œéœ€è¦è¾“å…¥ä¸€ä¸ªå¯†ç ï¼Œé€‰ä¸€ä¸ªå¥½è®°çš„ï¼Œæ¯”å¦‚123456\n1 2 openssl pkcs12 -export -clcerts -in client.crt -inkey client.key -out client.p12 openssl pkcs12 -export -clcerts -in client2.crt -inkey client2.key -out client2.p12 é‡å¤ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸¤å¥—å®¢æˆ·ç«¯è¯ä¹¦ï¼š\nclient.key / client2.keyï¼šå®¢æˆ·ç«¯çš„ç§é’¥æ–‡ä»¶ client.crt / client2.keyï¼šæœ‰æ•ˆæœŸåå¹´çš„å®¢æˆ·ç«¯è¯ä¹¦ ä½¿ç”¨æ ¹è¯ä¹¦å’Œå®¢æˆ·ç«¯ç§é’¥ä¸€èµ·ç”Ÿæˆ client.p12/client2.p12ï¼Œè¿™ä¸ªè¯ä¹¦æ–‡ä»¶åŒ…å«å®¢æˆ·ç«¯çš„å…¬é’¥å’Œç§é’¥ï¼Œä¸»è¦ç”¨æ¥ç»™æµè§ˆå™¨è®¿é—®ä½¿ç”¨\néªŒè¯ ä½¿ç”¨ curl åŠ ä¸Šè¯ä¹¦è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥æµ‹è¯• Nginx çš„ HTTPS åŒå‘è®¤è¯æ˜¯å¦é…ç½®æˆåŠŸã€‚ä¸‹é¢æˆ‘ä»¬æµ‹è¯•ä¸‰ä¸ªç”¨ä¾‹ï¼š\nä½¿ç”¨ client.crt / client.key è¿™ä¸€å¥—å®¢æˆ·ç«¯è¯ä¹¦æ¥è°ƒç”¨æœåŠ¡å™¨ç«¯ ä½¿ç”¨ client2.crt / client2.key è¿™ä¸€å¥—å®¢æˆ·ç«¯è¯ä¹¦æ¥è°ƒç”¨æœåŠ¡å™¨ç«¯ ä¸ä½¿ç”¨è¯ä¹¦æ¥è°ƒç”¨æœåŠ¡å™¨ç«¯ å¸¦è¯ä¹¦çš„æˆåŠŸè°ƒç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 #--certæŒ‡å®šå®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦çš„è·¯å¾„ #--keyæŒ‡å®šå®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶çš„è·¯å¾„ #-k ä½¿ç”¨æœ¬å‚æ•°ä¸æ ¡éªŒè¯ä¹¦çš„åˆæ³•æ€§ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯è‡ªç­¾åè¯ä¹¦ #å¯ä»¥ä½¿ç”¨-væ¥è§‚å¯Ÿå…·ä½“çš„SSLæ¡æ‰‹è¿‡ç¨‹ curl --cert ./client.crt --key ./client.key https://integration-fred2.fredhuang.com -k -v * Rebuilt URL to: https://47.93.XX.XX/ * Trying 47.93.XX.XX... * TCP_NODELAY set * Connected to 47.93.XX.XX (47.93.XX.XX) port 443 (#0) * ALPN, offering h2 * ALPN, offering http/1.1 * Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH * successfully set certificate verify locations: * CAfile: /etc/ssl/cert.pem CApath: none * TLSv1.2 (OUT), TLS handshake, Client hello (1): * TLSv1.2 (IN), TLS handshake, Server hello (2): * TLSv1.2 (IN), TLS handshake, Certificate (11): * TLSv1.2 (IN), TLS handshake, Server key exchange (12): * TLSv1.2 (IN), TLS handshake, Request CERT (13): * TLSv1.2 (IN), TLS handshake, Server finished (14): * TLSv1.2 (OUT), TLS handshake, Certificate (11): * TLSv1.2 (OUT), TLS handshake, Client key exchange (16): * TLSv1.2 (OUT), TLS handshake, CERT verify (15): * TLSv1.2 (OUT), TLS change cipher, Client hello (1): * TLSv1.2 (OUT), TLS handshake, Finished (20): * TLSv1.2 (IN), TLS change cipher, Client hello (1): * TLSv1.2 (IN), TLS handshake, Finished (20): * SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384 * ALPN, server accepted to use http/1.1 * Server certificate: * subject: C=CN; ST=BJ; L=BJ; O=Alibaba; OU=Test; CN=integration-fred2.fredhuang.com; emailAddress=a@alibaba.com * start date: Nov 2 01:01:34 2019 GMT * expire date: Oct 30 01:01:34 2029 GMT * issuer: C=CN; ST=BJ; L=BJ; O=Alibaba; OU=Test; CN=root; emailAddress=a@alibaba.com * SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway. \u0026gt; GET / HTTP/1.1 \u0026gt; host:integration-fred2.fredhuang.com \u0026gt; User-Agent: curl/7.54.0 \u0026gt; Accept: */* \u0026gt; \u0026lt; HTTP/1.1 200 OK \u0026lt; Server: nginx/1.17.5 \u0026lt; Date: Sat, 02 Nov 2019 02:39:43 GMT \u0026lt; Content-Type: text/html \u0026lt; Content-Length: 612 \u0026lt; Last-Modified: Wed, 30 Oct 2019 11:29:45 GMT \u0026lt; Connection: keep-alive \u0026lt; ETag: \u0026#34;5db97429-264\u0026#34; \u0026lt; Accept-Ranges: bytes \u0026lt; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; * Connection #0 to host 47.93.XX.XX left intact ä½¿ç”¨ client2.crt / client2.key è¿™ä¸€å¥—å®¢æˆ·ç«¯è¯ä¹¦æ¥è°ƒç”¨æœåŠ¡å™¨ç«¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 curl --cert ./client2.crt --key ./client2.key https://integration-fred2.fredhuang.com -k \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ä¸å¸¦è¯ä¹¦çš„è°ƒç”¨ 1 2 3 4 5 6 7 8 9 curl https://integration-fred2.fredhuang.com -k \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;400 No required SSL certificate was sent\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;400 Bad Request\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;center\u0026gt;No required SSL certificate was sent\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx/1.17.5\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ä¸‰ä¸ªç”¨ä¾‹éƒ½ç¬¦åˆé¢„æœŸï¼Œä»ç¬¬ä¸€ä¸ªæµ‹è¯•æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªé€šä¿¡è¿‡ç¨‹è¾ƒé•¿ï¼Œå®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨ç«¯çš„è¯ä¹¦ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°†è‡ªå·±çš„è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯è¿›è¡ŒéªŒè¯ã€‚ä½¿ç”¨æ ¹è¯ä¹¦é¢å‘çš„ä¸¤ä¸ªå®¢æˆ·ç«¯è¯ä¹¦éƒ½å¯ä»¥æ­£å¸¸å‘èµ·åŒå‘HTTPSè®¤è¯çš„è°ƒç”¨ã€‚æ²¡æœ‰å¸¦å®¢æˆ·ç«¯è¯ä¹¦çš„è°ƒç”¨ä¼šè¢«æœåŠ¡å™¨ç«¯æ‹’ç»æœåŠ¡ã€‚\nReference ä»€ä¹ˆæ˜¯HTTPSåŒå‘è®¤è¯(Mutual TLS authentication)_API ç½‘å…³(API Gateway)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ\nä½¿ç”¨CLBéƒ¨ç½²HTTPSä¸šåŠ¡ï¼ˆåŒå‘è®¤è¯ï¼‰_è´Ÿè½½å‡è¡¡(SLB)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ\n","date":"2024-06-09T16:47:46+08:00","image":"https://capriwits.com/post/https-tls-and-mtls-and-certificate-related/mtls-cover_hu5ea97cf0b56c46c093e1d5cc353e6933_30783_120x120_fill_box_smart1_3.png","permalink":"https://capriwits.com/post/https-tls-and-mtls-and-certificate-related/","title":"HTTPS å•åŒå‘è®¤è¯åŠè¯ä¹¦ç›¸å…³"},{"content":" Java å·¦å€¼å’Œå³å€¼çš„æ€è€ƒ å‰è¨€ é—®é¢˜å¤ç° å­—èŠ‚ç åˆ†æ å…¶ä»–å®éªŒ Summary ğŸ”—Reference Java å·¦å€¼å’Œå³å€¼çš„æ€è€ƒ å‰è¨€ åˆ·ç®—æ³•é¢˜ï¼Œç”¨åˆ°å°æ ¹å †ã€ŒPriorityQueueã€ï¼Œ å…¶ä¸­ä¸€ä¸ªæ“ä½œè®©æˆ‘å›°æƒ‘äº†å¾ˆä¹…\nå°æ ¹å †å­˜å‚¨çš„æ˜¯åŸæ•°ç»„ä¸ºè´Ÿå€¼çš„ä¸‹æ ‡ï¼Œåˆ™å°æ ¹å †å †é¡¶ä¸ºæœ€å°è´Ÿæ•°çš„ä¸‹æ ‡\næœ¬æ„æ˜¯å¾ªç¯ä¸­ï¼Œè®©æœ€å°è´Ÿæ•°å–åˆ°ç›¸åæ•° k æ¬¡ï¼Œå˜æˆä¸€ä¸ªæ­£æ•°\nwhile (k-- \u0026gt; 0) nums[queue.peek()] = -nums[queue.poll()];\nè¿™ä¸€æ“ä½œè®©æˆ‘ç–‘æƒ‘äº†å¾ˆä¹…ï¼Œæ ¹æ®èµ‹å€¼è¡¨è¾¾å¼çš„æ€§è´¨ï¼Œåº”è¯¥æ˜¯ä»å³è®¡ç®—åˆ°å·¦ï¼Œä½†æ˜¯å¦‚æœæŒ‰ç…§è¿™ä¸ªé€»è¾‘ï¼Œå°±ä¼šè®© poll() å…ˆè¿›è¡Œï¼Œåé¢æ‰ peek() ï¼Œ è¿™æ ·ä¸‹æ ‡çš„è®¡ç®—å°±å‡ºé”™äº†, å³ peek() å®é™…å–çš„ä¸‹æ ‡å€¼å·²ç»è¢« poll() å‡ºå †äº†\né—®é¢˜å¤ç° 1 2 3 4 5 6 public static void main(String[] args) { int[] nums = {2, 1, 0}; PriorityQueue\u0026lt;Integer\u0026gt; pq = new PriorityQueue\u0026lt;\u0026gt;(List.of(0, 1, 2)); nums[pq.peek()] = -nums[pq.poll()]; System.out.println(Arrays.toString(nums)); // [-2, 1, 0] } å°æ ¹å­˜å­˜å‚¨åŸæ•°ç»„ä¸‹æ ‡ï¼Œæ­¤æ—¶å †é¡¶ä¸º 0\nnums[pq.peek()] = -nums[pq.poll()] å®é™…æ‰§è¡Œè¿è¡Œæ—¶çŠ¶æ€æ˜¯å…ˆæ‰§è¡Œ peek()ï¼Œå†æ‰§è¡Œ poll()ï¼Œå³ä»å·¦åˆ°å³ï¼Œä¸èµ‹å€¼è¿ç®—ç¬¦ = å³å€¼èµ‹å€¼ç»™å·¦å€¼ä¸åŒ\nå³ nums[0] = -nums[0] å–å\nå­—èŠ‚ç åˆ†æ ä½¿ç”¨ javap -c Solution.class åç¼–è¯‘å­—èŠ‚ç åˆ†æ\n1 2 3 4 5 6 7 8 9 10 11 12 13 32: invokestatic #15 // InterfaceMethod java/util/List.of:(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/util/List; 35: invokespecial #21 // Method java/util/PriorityQueue.\u0026#34;\u0026lt;init\u0026gt;\u0026#34;:(Ljava/util/Collection;)V 38: astore_2 39: aload_1 40: aload_2 41: invokevirtual #24 // Method java/util/PriorityQueue.peek:()Ljava/lang/Object; 44: checkcast #10 // class java/lang/Integer 47: invokevirtual #28 // Method java/lang/Integer.intValue:()I 50: aload_1 51: aload_2 52: invokevirtual #32 // Method java/util/PriorityQueue.poll:()Ljava/lang/Object; 55: checkcast #10 // class java/lang/Integer 58: invokevirtual #28 // Method java/lang/Integer.intValue:()I å…ˆæ˜¯å †çš„åˆå§‹åŒ–ï¼Œç„¶åå…ˆæ‰§è¡Œ peek() å†æ‰§è¡Œ poll(), å³ä»å·¦åˆ°å³çš„é¡ºåºç¼–è¯‘\nå…¶ä»–å®éªŒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public static void main(String[] args) { int[] nums = {4, 5, 6}; nums[getIndex()] = -nums[getValue()]; // Should call getIndex first, then getValue System.out.println(Arrays.toString(nums)); // [4, -6, 6] } public static int getIndex() { System.out.println(\u0026#34;getIndex called\u0026#34;); return 1; } public static int getValue() { System.out.println(\u0026#34;getValue called\u0026#34;); return 2; } getIndex called\ngetValue called\n[4, -6, 6]\n1 2 3 18: invokestatic #7 // Method getIndex:()I 21: aload_1 22: invokestatic #13 // Method getValue:()I åŒæ ·ï¼Œç¼–è¯‘é¡ºåºä¹Ÿæ˜¯ä»å·¦è‡³å³\nSummary ä¸èƒ½æŒ‰ç…§èµ‹å€¼è¡¨è¾¾å¼ = ä»å³å‘å·¦è¿è¡Œçš„æ€æƒ³æ€è€ƒ nums[queue.peek()] = -nums[queue.poll()]; æœ€ç»ˆçš„èµ‹å€¼çš„ç¡®ä¼šæŒ‰ç…§å³å‘å·¦æ‰§è¡Œã€Œèµ‹å€¼æ“ä½œã€ï¼Œå®Œæˆ ç½®ç›¸åæ•° çš„æ“ä½œ ä½†æ˜¯ä»æœ€ç»ˆå­—èŠ‚ç çš„æ‰§è¡Œé¡ºåºæ¥çœ‹ï¼Œå¯¹äº è¡¨è¾¾å¼ çš„è®¡ç®—ï¼Œä¼š ä»å·¦å‘å³ è®¡ç®—ï¼Œå°†å‰åºå‡†å¤‡å·¥ä½œã€Œå–å€¼ã€å®Œæˆåï¼Œæ‰è¿›è¡Œå†™æ“ä½œï¼Œèµ‹å€¼ã€‚ ğŸ”—Reference 1005. K æ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ\n","date":"2024-06-02T18:57:02+08:00","image":"https://capriwits.com/post/thoughts-on-java-lvalues-and-rvalues/java-programming-cover_hu4193375dbb5d85283668ea46b44f9b7a_34987_120x120_fill_box_smart1_3.png","permalink":"https://capriwits.com/post/thoughts-on-java-lvalues-and-rvalues/","title":"Java å·¦å€¼å’Œå³å€¼çš„æ€è€ƒ"},{"content":" å…³äºè®¾è®¡ç»å¯¹å€¼absçš„ä¸€äº›æ€è€ƒ æœ€ç»ˆå®ç° ğŸ”—Reference å…³äºè®¾è®¡ç»å¯¹å€¼absçš„ä¸€äº›æ€è€ƒ ã€Œå–ç»å¯¹å€¼ã€å¯¹äº Integer æ¯«æ— ç–‘é—®ç›´æ¥åˆ¤æ–­æ­£è´Ÿ\nMath::abs(int) 1 2 3 public static int abs(int a) { return (a \u0026lt; 0) ? -a : a; } æ³¨æ„åˆ°åŒç²¾åº¦æµ®ç‚¹æ•° Double å®˜æ–¹ä½¿ç”¨ä»¥ä¸‹å®ç°\nMath::abs(double) 1 2 3 public static double abs(double a) { return (a \u0026lt;= 0.0D) ? 0.0D - a : a; } Java éµå¾ª IEEE-754 æ ‡å‡†ï¼Œå› æ­¤å®ç°ä¸Šå­˜åœ¨ +0.0 \u0026amp; -0.0 ï¼Œä¸¤è€…é™¤äº†æ–‡æœ¬è¡¨ç¤ºä¸åŒï¼Œåœ¨è®¡ç®—è¿‡ç¨‹ä¸­ä¹Ÿä¸åŒã€‚å¦‚ï¼š1 / +- 0.0 å¾—åˆ°çš„ç»“æœæ˜¯ +Infinity \u0026amp; -Infinity\nabs è®¡ç®—ç»“æœä»ç„¶æ˜¯è´Ÿæ•°ï¼Œå‡ºç°é”™è¯¯ï¼ŒåŸå› æ—¢æ˜¯ +0.0 == -0.0\n1 2 3 4 5 6 7 8 9 10 11 12 13 public class Solution { public static void main(String[] args) { double x = -0.0; if (1 / abs(x) \u0026lt; 0) { System.out.println(\u0026#34;abs(x) \u0026lt; 0\u0026#34;); } } public static double abs(double a) { return (a \u0026lt; 0) ? -a : a; } } å°è¯•è§£å†³é—®é¢˜ï¼Œæ·»åŠ åˆ¤æ–­æ¡ä»¶ï¼šif (val \u0026lt; 0 || val == -0.0) å¯¹ -0.0 å•ç‹¬è€ƒè™‘ï¼Œè¿›è¡ŒåŒé‡åˆ¤æ–­ï¼Œè¿™é‡Œé‡‡ç”¨ Double::compare(double, double) å®ç°\næˆåŠŸå®ç°\n1 2 3 4 5 6 public static double abs(double value) { if (value \u0026lt; 0 || Double.compare(value, -0.0) == 0) { return -value; } return value; } å†è¿½æ±‚æè‡´çš„ä¼˜åŒ–ã€‚æŸ¥çœ‹ Double::compare å®ç°ã€‚\nå¯¹äºæ­£æ•°è¿›è¡Œé¢å¤–çš„ä¸¤æ¬¡æ¯”è¾ƒ, å¯¹äº -0.0 è¿›è¡Œé¢å¤–çš„ ä¸‰æ¬¡ æ¯”è¾ƒ, å¯¹äº +0.0 è¿›è¡Œé¢å¤–çš„ å››æ¬¡ æ¯”è¾ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 public static int compare(double d1, double d2) { if (d1 \u0026lt; d2) return -1; // Neither val is NaN, thisVal is smaller if (d1 \u0026gt; d2) return 1; // Neither val is NaN, thisVal is larger // Cannot use doubleToRawLongBits because of possibility of NaNs. long thisBits = Double.doubleToLongBits(d1); long anotherBits = Double.doubleToLongBits(d2); return (thisBits == anotherBits ? 0 : // Values are equal (thisBits \u0026lt; anotherBits ? -1 : // (-0.0, 0.0) or (!NaN, NaN) 1)); // (0.0, -0.0) or (NaN, !NaN) } è€Œå®é™…ä¸Šï¼Œè¦æƒ³å®ç°åªéœ€è¦ Double::doubleToLongBits æ–¹æ³•ï¼Œå°† Double è½¬ Long\n1 2 3 4 5 6 7 8 9 private static final long MINUS_ZERO_LONG_BITS = Double.doubleToLongBits(-0.0); public static double abs(double value) { if (value \u0026lt; 0 || Double.doubleToLongBits(value) == MINUS_ZERO_LONG_BITS) { return -value; } return value; } ä¸è¿‡ Double::doubleToLongBits ä¹Ÿåªæœ‰å¾®ä¸è¶³é“çš„æ€§èƒ½æå‡ï¼Œå› ä¸ºå®ƒä¼šå¯¹ NaN è¿›è¡Œçº¦æŸï¼ŒNaN ä¼šèµ‹å€¼ä¸º 0x7ff8000000000000L ï¼Œå¦‚æœç¡®ä¿ abs å…¥å‚è‚¯å®šæ˜¯ doubleï¼Œåˆ™åªéœ€è¦å–å‡º Double::doubleToRawLongBits\n1 2 3 4 5 6 public static long doubleToLongBits(double value) { if (!isNaN(value)) { return doubleToRawLongBits(value); } return 0x7ff8000000000000L; } äºæ˜¯å°±å˜æˆè¿™æ ·å®ç°\n1 2 3 4 5 6 7 8 9 private static final long MINUS_ZERO_LONG_BITS = Double.doubleToRawLongBits(-0.0); public static double abs(double value) { if (value \u0026lt; 0 || Double.doubleToRawLongBits(value) == MINUS_ZERO_LONG_BITS) { return -value; } return value; } åˆ° JDK8 å°±ç»“æŸäº†ï¼Œè€Œ JDK9 å¼€å§‹å¼•å…¥ @HotSpotIntrinsicCandidate æ³¨è§£ï¼Œå³ HotSpot JVM å†…éƒ¨çš„ JIT compiler ä¼šç§»é™¤ JDK ä¸­çš„å®ç°æ–¹æ³•ï¼Œé‡‡ç”¨ CPU æŒ‡ä»¤ç›´æ¥å®ç°ï¼Œè¿™ä¼šæ¯”é«˜çº§è¯­è¨€è½¬æ±‡ç¼–è½¬æœºå™¨è¯­è¨€è¦å¿«å¾ˆå¤šï¼Œæ¯•ç«Ÿ CPU å¹¶ä¸ä¼šåœ¨ä¹æ•°æ®ç±»å‹çš„é—®é¢˜ï¼Œåªéœ€è¦é‡æ–°è§£é‡Š(reinterpreting) å‚¨å­˜åœ¨ CPU å¯„å­˜å™¨çš„ä¸€ç»„ä½çš„é—®é¢˜ï¼Œä»¥ä¾¿äºä¸ Java æ•°æ®ç±»å‹ä¸€è‡´ã€‚\n1 2 @HotSpotIntrinsicCandidate public static native long doubleToRawLongBits(double value); ä½†è¿™ä¹ˆå®ç°ï¼Œä»ç„¶æœ‰æ¡ä»¶åˆ†æ”¯ï¼Œå¦‚æœ CPU åˆ†æ”¯é¢„æµ‹(branch predictor) å¤±è¯¯ï¼Œæ€§èƒ½å¼€é”€å°±ä¼šå¢å¤§ã€‚æ¥ä¸‹æ¥è€ƒè™‘å‡å°‘æ¡ä»¶åˆ†æ”¯ã€‚\nåˆ©ç”¨ 0.0 ä¸ +/0.0 ä½œå·®ï¼Œéƒ½ä¼šä½¿æ­£è´Ÿé›¶è½¬åŒ–ä¸ºæ­£é›¶\n1 2 System.out.println(0.0-(-0.0)); // 0.0 System.out.println(0.0-(+0.0)); // 0.0 å¯¹æ–¹æ³•è¿›è¡Œæ”¹å†™\n1 2 3 4 5 6 7 8 9 public static double abs(double value) { if (value == 0) { return 0.0 - value; } if (value \u0026lt; 0) { return -value; } return value; } æ³¨æ„åˆ°å¯¹äºæ™®é€šè´Ÿæ•°è€Œè¨€ï¼Œ0.0 - value ä¸ -value çš„ç»“æœç›¸åŒï¼Œæ‰€ä»¥åˆå¹¶åˆ†æ”¯\n1 2 3 4 5 6 public static double abs(double value) { if (value \u0026lt;= 0) { return 0.0 - value; } return value; } AKA\n1 2 3 public static double abs(double a) { return (a \u0026lt;= 0.0) ? 0.0 - a : a; } ä¼šå‘ç°ï¼ŒJDK Math::abs(double,double) å®ç°ç›¸åŒï¼ˆé€ƒ\néµå¾ª IEEE-754 çš„åŒç²¾åº¦æµ®ç‚¹æ•°äºŒè¿›åˆ¶è¡¨è¾¾å½¢å¼ï¼Œåªéœ€è¦å°†äºŒè¿›åˆ¶åœ¨é«˜ä½ç¬¦å·ä½æ”¹æˆ 0 å³å¯å®ç°è½¬æ­£æ•°(abs) ï¼Œéœ€è¦æ©ç  0x7fffffffffffffffL == 63ä½ 1 bit\n1 System.out.println(Long.bitCount(0x7fffffffffffffffL)); // 63 æœ€ç»ˆå®ç° 1 2 3 4 public static double abs(double value) { return Double.longBitsToDouble( Double.doubleToRawLongBits(value) \u0026amp; 0x7fffffffffffffffL); } ğŸ“Œæ­¤ç‰ˆæœ¬ä¸å­˜åœ¨åˆ†æ”¯ï¼Œåœ¨æŸäº›æ¡ä»¶ä¸‹çš„ååé‡å¢åŠ  10%ï¼Œå•åˆ†æ”¯å®ç°åœ¨ Java æ ‡å‡†åº“å­˜åœ¨å¤šå¹´ï¼Œåœ¨éšå³åˆ°æ¥çš„ JDK 18 ä¸­ï¼Œæ”¹è¿›ç‰ˆæœ¬å·²ç»æäº¤ã€ŒFrom: 2021/9/18ã€\nç„¶è€Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™äº›æ”¹è¿›å¹¶æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå› ä¸º JIT ç¼–è¯‘å™¨ä¼šé€‚å½“ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤(if available) ä¼šå®Œå…¨æ›¿ä»£ Java codeï¼Œæ‰€ä»¥è¿™ç§æ”¹åŠ¨å¹¶ ä¸èƒ½ ä½¿ç¨‹åºæ˜¾è‘—æ€§æå‡å¾ˆå¤šï¼ˆé€ƒ\nğŸ”—Reference One does not simply calculate the absolute value\nOpenJDK Double::compare\nJavaSE 8 doubleToLongBits\n","date":"2021-09-18T17:34:24+08:00","image":"https://capriwits.com/post/some-thoughts-on-designing-absolute-method/java-programming-cover_hu4193375dbb5d85283668ea46b44f9b7a_34987_120x120_fill_box_smart1_3.png","permalink":"https://capriwits.com/post/some-thoughts-on-designing-absolute-method/","title":"å…³äºè®¾è®¡ç»å¯¹å€¼ abs() çš„ä¸€äº›æ€è€ƒ"},{"content":" Java For-loop For-each Iterator æ•ˆç‡åˆ†æ System.nanoTime è®¡æ—¶æµ‹è¯• æ•°é‡çº§ï¼š1,000 æ•°é‡çº§ï¼š10,000 æ•°é‡çº§ï¼š100,000 JMH BenchMark åŸºå‡†æµ‹è¯• åŸºå‡†æµ‹è¯•ç»“æœåˆ†æ ä¸‰ç§å¾ªç¯çš„ä½¿ç”¨å»ºè®® For-each ä¼˜åŠ¿äº While-loop é¢„é˜²Bug ä¸ºä»€ä¹ˆè¦â€œå°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–â€ For-each ä¼˜åŠ¿äº For-loop For-each æ— æ³•ä½¿ç”¨çš„åœ°æ–¹ For-each æ‹“å±•ä½¿ç”¨ æ€»ç»“ Java For-loop For-each Iterator æ•ˆç‡åˆ†æ System.nanoTime è®¡æ—¶æµ‹è¯• ä½¿ç”¨ System.nanoTime() ä½œå·®è®¡ç®—è€—æ—¶ LinkedList::get(int index) æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œloop ä¸­çš„æ“ä½œå¿…é¡»ä¿æŒä¸€è‡´ï¼Œå› æ­¤ç”¨ ArrayList åš Iterator çš„é›†åˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 import java.util.*; public class Solution { public static final int MAGNITUDE = 10000; // æ•°é‡çº§ public static long testForloop(List\u0026lt;String\u0026gt; list) { long start, end; String str = null; start = System.nanoTime(); for (int i = 0; i \u0026lt; MAGNITUDE; i++) { str = list.get(i); } end = System.nanoTime(); return end - start; } public static long testForeach(List\u0026lt;String\u0026gt; list) { long start, end; String str = null; start = System.nanoTime(); for (String s : list) { str = s; } end = System.nanoTime(); return end - start; } public static long testIterator(List\u0026lt;String\u0026gt; list) { long start, end; String str = null; start = System.nanoTime(); Iterator\u0026lt;String\u0026gt; iterator = list.iterator(); while (iterator.hasNext()) { str = iterator.next(); } end = System.nanoTime(); return end - start; } public static void main(String[] args) { /* initialize */ List\u0026lt;String\u0026gt; arrayList = new ArrayList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; MAGNITUDE; i++) { arrayList.add(String.valueOf(i)); } System.out.println(\u0026#34;For loop: \u0026#34; + testForloop(arrayList)); System.out.println(\u0026#34;Foreach: \u0026#34; + testForeach(arrayList)); System.out.println(\u0026#34;Iterator: \u0026#34; + testIterator(arrayList)); } } æ•°é‡çº§ï¼š1,000 For loop: 99000\nForeach: 321700\nIterator: 194500\næ•°é‡çº§ï¼š10,000 For loop: 933200\nForeach: 942500\nIterator: 585800\næ•°é‡çº§ï¼š100,000 For loop: 3730800\nForeach: 6669800\nIterator: 5215100\nåœ¨å°æ•°é‡çº§ä¸Šï¼ŒFor-loop æ•ˆç‡ä¼šé«˜ä¸€ç‚¹ï¼ŒFor \u0026lt; Iterator \u0026lt; For-eachï¼Œ è¿™é‡Œå¾—å‡ºçš„ç»“è®ºæ ¹æ®æ—¶é—´æ¶ˆè€—å¾—å‡ºï¼Œæ— æ³•ä»”ç»†æ¯”è¾ƒæ•ˆç‡é«˜ä½ï¼Œæ•°é‡çº§å°æ—¶ï¼ŒFor-loop æ•ˆç‡é«˜ä¸€ç‚¹ï¼Œæ•´ä½“æ¥è¯´ï¼Œä¸‰è€…é€Ÿåº¦çº§åˆ«å·®ä¸å¤šã€‚\nJMH BenchMark åŸºå‡†æµ‹è¯• ä½¿ç”¨åˆ° JMH åŸºå‡†æµ‹è¯•éªŒè¯ä¸‰ç§å¾ªç¯ï¼Œæ•°é‡çº§ä¸ºç™¾ä¸‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 import org.openjdk.jmh.annotations.*; import org.openjdk.jmh.infra.Blackhole; import org.openjdk.jmh.results.format.ResultFormatType; import org.openjdk.jmh.runner.Runner; import org.openjdk.jmh.runner.options.Options; import org.openjdk.jmh.runner.options.OptionsBuilder; import java.util.ArrayList; import java.util.Iterator; import java.util.List; import java.util.concurrent.TimeUnit; @State(Scope.Thread) @BenchmarkMode(Mode.AverageTime) @OutputTimeUnit(TimeUnit.NANOSECONDS) @Fork(1) @Warmup(iterations = 3) @Measurement(iterations = 5) public class JavaLoopBenchMarkTest { private static final int SIZE = 1_000_000; private String[] array; private List\u0026lt;String\u0026gt; arrayList; @Setup public void setup() { array = new String[SIZE]; arrayList = new ArrayList\u0026lt;\u0026gt;(SIZE); for (int i = 0; i \u0026lt; SIZE; i++) { array[i] = String.valueOf(i); arrayList.add(array[i]); } } @Benchmark public void testForLoop(Blackhole bh) { for (int i = 0; i \u0026lt; SIZE; i++) { bh.consume(array[i]); } } @Benchmark public void testForEachLoop(Blackhole bh) { for (String s : array) { bh.consume(s); } } @Benchmark public void testIterator(Blackhole bh) { Iterator\u0026lt;String\u0026gt; iterator = arrayList.iterator(); while (iterator.hasNext()) { bh.consume(iterator.next()); } } public static void main(String[] args) throws Exception { Options opt = new OptionsBuilder() .include(JavaLoopBenchMarkTest.class.getSimpleName()) .forks(1) .resultFormat(ResultFormatType.JSON) .result(\u0026#34;benchmark-results.json\u0026#34;) // ç”Ÿæˆ json æŠ¥å‘Šï¼ŒJMH Visual Chart å¯è§†åŒ–åˆ†æ .build(); new Runner(opt).run(); } } åŸºå‡†æµ‹è¯•ç»“æœåˆ†æ 1 2 3 4 Benchmark Mode Cnt Score Error Units JavaLoopBenchMarkTest.testForEachLoop avgt 5 143919.250 Â± 8507.941 ns/op JavaLoopBenchMarkTest.testForLoop avgt 5 139981.040 Â± 4770.272 ns/op JavaLoopBenchMarkTest.testIterator avgt 5 142754.313 Â± 8949.872 ns/op ä¸¥æ ¼æ¥è®²ä¸‰è€…é€Ÿåº¦å‡ ä¹ä¸ç›¸ä¸Šä¸‹ï¼Œç¡¬æ˜¯è¦è¯´æœ€å¿«ï¼Œåº”è¯¥æ˜¯åŸç”Ÿ For-loop, For-each å’Œ Iterator åº”è¯¥æ˜¯ä¸€æ ·çš„\nä¸‰ç§å¾ªç¯çš„ä½¿ç”¨å»ºè®® ã€ŠEffective Javaã€‹ ç¬¬ä¸‰ç‰ˆç¬¬ 58 æ¡ä¸­å»ºè®®ï¼Œä¸€èˆ¬é‡‡ç”¨ Foreach è¿›è¡Œå¾ªç¯ï¼Œå› ä¸ºå®ƒåœ¨ ç®€æ´æ€§å’Œ é¢„é˜²Bugä¸Šä¼˜äº For-loop å’Œ Iteratorï¼ˆç¡®åˆ‡è¯´æ˜¯ Iterator é…åˆ while ä½¿ç”¨ï¼‰\nFor-each ä¼˜åŠ¿äº While-loop é¢„é˜²Bug è¯´åˆ°é¢„é˜²Bugï¼Œè¿™é‡Œç‰µæ¶‰åˆ° ç¬¬57æ¡ ä¸­çš„ å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–ã€‚ ä¸ºä»€ä¹ˆè¦â€œå°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–â€ ä¹¦ä¸­æåˆ°ï¼ŒåŸå› ç±»ä¼¼äºç¬¬ 15 æ¡çš„æœ¬è´¨ï¼Œä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–ã€‚\nå°†å±€éƒ¨å˜é‡ä½œç”¨åŸŸæœ€å°åŒ–ï¼Œå¯ä»¥å¢å¼ºä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå¹¶é™ä½å‡ºé”™çš„å¯èƒ½æ€§ã€‚\nå¾ªç¯ä¸­æä¾›äº†ç‰¹æ®Šçš„æœºä¼šæ¥å°†å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–ã€‚\næ— è®ºæ˜¯ä¼ ç»Ÿçš„ for å¾ªç¯ï¼Œè¿˜æ˜¯ for-each å½¢å¼çš„ for å¾ªç¯ï¼Œéƒ½å…è®¸å£°æ˜å¾ªç¯å˜é‡ï¼Œå®ƒä»¬çš„ä½œç”¨åŸŸè¢«é™å®šåœ¨æ­£å¥½éœ€è¦çš„èŒƒå›´ä¹‹å†…ã€‚\nå¦‚æœåœ¨å¾ªç¯ç»ˆæ­¢ä¹‹åä¸å†éœ€è¦å¾ªç¯å˜é‡çš„å†…å®¹ï¼Œfor-loop å°±ä¼˜å…ˆäº while-loopã€‚\nå¦‚ä¸‹æ˜¯ä¸€ç§éå†é›†åˆçš„é¦–é€‰åšæ³•ï¼š 1 2 3 4 // Preferred idiom for iterating over a collection or array for (Element e : c) { ... // Do Someting with e } å¦‚æœéœ€è¦è®¿é—®è¿­ä»£å™¨ï¼Œå¯èƒ½è¦è°ƒç”¨å®ƒçš„ remove æ–¹æ³•ï¼Œé¦–é€‰åšæ³•æ˜¯åˆ©ç”¨ä¼ ç»Ÿçš„ for å¾ªç¯æ›¿ä»£ for-each å¾ªç¯ï¼š 1 2 3 4 5 // Idiom for iterating when you need the iterator for (Iterator\u0026lt;Element\u0026gt; i = c.iterator(); i.hasNext(); ) { Element e = i.next(); ... // Do someting with e and i } ä¸ºä»€ä¹ˆæœ‰äº›æ—¶å€™ä¸èƒ½ç”¨ for-each ï¼Œé‰´äºå®ƒæ˜¯åŸºäº Iterator çš„ hasNext() + next()ï¼Œæœ‰æ—¶å€™éœ€è¦åœ¨å¾ªç¯è¿‡ç¨‹ä¸­å¯¹é›†åˆè¿›è¡Œæ“ä½œï¼Œ\næ­¤æ—¶å°±å¿…é¡»ä½¿ç”¨ Iterator å¯¹è±¡è¿›è¡Œæ“ä½œäº†ï¼Œå› ä¸ºä½¿ç”¨ Iterator å¾ªç¯æ—¶ï¼Œé›†åˆçš„æ“ä½œæƒå°±äº¤ç»™ Iteratorï¼Œ\nè™½ç„¶å¯ä»¥ç”¨é›†åˆå¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå¦‚ romove() ä½†è¿™æ ·ä¼šç ´å iterator åˆå§‹åŒ–çš„ç»“æœï¼Œå¯¼è‡´æœ€ç»ˆç¨‹åºè¿è¡Œçš„ç»“æœä¸é¢„æœŸåå·®å¾ˆå¤§\nè‡³äºä¸ºä»€ä¹ˆ for loop è¦æ¯” while loop æ›´å¥½ï¼Œå‚è€ƒä¸€ä¸‹ä»£ç ç‰‡æ®µï¼Œè¿ç»­çš„ä¸¤ä¸ª while loopï¼Œä»¥åŠå‡ºç°çš„ä¸€ä¸ª bug 1 2 3 4 5 6 7 8 9 Iterator\u0026lt;Element\u0026gt; i = c.iterator(); while (i.hasNext()) { doSometing(i.next()); } ... Iterator\u0026lt;Element\u0026gt; i2 = c.iterator(); while (i.hasNext()) { // This is bug! doSometing(i2.next()); } åœ¨ç¬¬äºŒä¸ª while loop ä¸­ï¼Œä½¿ç”¨äº† è¿­ä»£å™¨ i çš„åˆ¤æ–­ï¼Œå®é™…æ“ä½œçš„æ˜¯ i2 è¿­ä»£å™¨å¯¹è±¡, i è¿­ä»£å™¨å‘ç”Ÿæ³„éœ²ï¼Œè€Œä¸ä¼šè½»æ˜“è¢«å‘ç°ï¼ŒIDE ä¹Ÿä¸ä¼šæŠ¥é”™, æ‰€ä»¥è¦åˆ©ç”¨å¥½ for loop å£°æ˜è¿­ä»£å™¨ï¼Œæ§åˆ¶å®ƒçš„ä½œç”¨èŒƒå›´\nä¸Šé¢ bug ç¨‹åºæœ€ç»ˆçš„ç»“æœæ˜¯ä¸‹é¢çš„ while loop ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºåœ¨ä¸Šé¢çš„ while loop æ‰§è¡Œç»“æŸä¹‹åï¼Œè¿­ä»£å™¨ i å°±ä¼šéå†åˆ°å°½å¤´ï¼Œç»§ç»­åˆ¤æ–­ i.hasNext() åªä¼šè¿”å› false\nFor-each ä¼˜åŠ¿äº For-loop ä»¥ä¸‹é¢ä¸€ä¸ª ä¸¤å±‚é›†åˆåµŒå¥—è¿­ä»£å‡ºç°çš„ bug æ¥å±•å¼€è®¨è®º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Can you spot the bug? enum Suit {CLUB, DIAMOND, HEART, SPADE} enum Rank { ACE, DEUCE, THREE, FOUR, FIVE, SIX, SEVEN, EIGHT, NINE, TEN, JACK, QUEEN, KING } ... static Collection\u0026lt;Suit\u0026gt; suits = Arrays.asList(Suit.values()); static Collection\u0026lt;Rank\u0026gt; ranks = Arrays.asList(Rank.values()); List\u0026lt;Card\u0026gt; deck = new ArrayList\u0026lt;\u0026gt;(); for (Iterator\u0026lt;Suit\u0026gt; i = suits.iterator(); i.hasNext(); ) for (Iterator\u0026lt;Rank\u0026gt; j = ranks.iterator(); j.hasNext(); ) deck.add(new Card(i.next(), j.next())); bugåœ¨äºï¼Œåœ¨è¿­ä»£å™¨ä¸Šå¯¹å¤–éƒ¨çš„é›†åˆ suits è°ƒç”¨å¤ªå¤š next æ–¹æ³•ï¼Œå®ƒåº”è¯¥ä»å¤–éƒ¨çš„å¾ªç¯è¿›è¡Œè°ƒç”¨ï¼Œä»¥ä¾¿æ¯ç§èŠ±è‰²éƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä½†å®ƒå´æ˜¯ä»å†…éƒ¨å¾ªç¯è°ƒç”¨ï¼Œå› æ­¤æ¯æ¬¡ç‰Œè°ƒç”¨ä¸€æ¬¡ã€‚åœ¨ç”¨å®Œæ‰€æœ‰èŠ±è‰²ä¹‹åï¼Œå¾ªç¯å°±ä¼šæŠ›å‡º NoSuchElementExceptionå¼‚å¸¸ã€‚\nå¦‚æœç¢°å·§å¤–éƒ¨é›†åˆçš„å¤§å°æ˜¯å†…éƒ¨é›†åˆå¤§å°çš„å‡ å€ï¼ˆå¯èƒ½å› ä¸ºå®ƒä»¬æ˜¯ç›¸åŒçš„é›†åˆï¼‰ï¼Œå¾ªç¯å°±ä¼šæ­£å¸¸ç»ˆæ­¢ï¼Œä½†æ˜¯å®é™…å®Œæˆæƒ…å†µè·Ÿé¢„æœŸæ˜¯æœ‰å‡ºå…¥çš„ã€‚\nä¸‹é¢æ˜¯æ‰“å°ä¸€å¯¹éª°å­å‡ºç°çš„æ‰€æœ‰å¯èƒ½æƒ…å†µï¼š 1 2 3 4 5 6 7 // Same bug, different symptom! enum Face {ONE, TWO, THREE, FOUR, FIVE, SIX} Collection\u0026lt;Face\u0026gt; faces = EnumSet.allOf(Face.class); for (Iterator\u0026lt;Face\u0026gt; i = faces.iterator(); i.hasNext(); ) for (Iterator\u0026lt;Face\u0026gt; j = faces.iterator(); i.hasNext(); ) System.out.println(i.next() + \u0026#34; \u0026#34; + j.next()); ONE ONE\nTWO TWO\nTHREE THREE\nFOUR FOUR\nFIVE FIVE\nSIX SIX\nåŒæ ·çš„é”™è¯¯ï¼Œä¹Ÿæ˜¯é‡å¤è°ƒç”¨ nextã€‚è¿™ç§ç¨‹åºä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥å¾€å¾€æ‰¾ bug ä¼šç‰¹åˆ«éš¾å—\nä¸‹é¢å¼€å§‹ä¿®æ­£æ­¤ bug 1 2 3 4 5 6 // Fixed, but ugly - so we need for-each for (Iterator\u0026lt;Suit\u0026gt; i = suits.iterator(); i.hasNext(); ) { Suit suit = i.next(); for (Iterator\u0026lt;Rank\u0026gt; j = ranks.iterator(); j.hasNext(); ) deck.add(new Card(suit, j.next())); } è‡³æ­¤å¼•å‡º for-each ï¼Œè®©è¿™ä¸ªé—®é¢˜å®Œå…¨æ¶ˆå¤±ï¼Œå¹¶ä¸”äº§ç”Ÿçš„ä»£ç ä¹Ÿèƒ½å¾ˆç®€æ´ã€‚ 1 2 3 4 // Preferred idiom for neat iteration on collections and arrays for (Suit suit : suits) for (Rank rank : ranks) deck.add(new Card(suit, rank)); For-each æ— æ³•ä½¿ç”¨çš„åœ°æ–¹ è§£æ„è¿‡æ»¤ï¼šå¦‚æœéœ€è¦éå†é›†åˆï¼Œå¹¶åˆ é™¤æŒ‡å®šå…ƒç´ ï¼Œéœ€è¦ä½¿ç”¨æ˜¾å¼çš„è¿­ä»£å™¨ï¼Œä»¥ä¾¿ä½¿ç”¨å®ƒçš„ remove æ–¹æ³•ã€‚ä½¿ç”¨ Java 8 ä¸­æ·»åŠ çš„ Collection çš„ removeIfï¼Œå¸¸å¸¸å¯ä»¥é¿å…æ˜¾å¼éå†ã€‚ è½¬æ¢ï¼šå¦‚æœéœ€è¦éå†åˆ—è¡¨æˆ–è€…æ•°ç»„ï¼Œå¹¶å–ä»£å®ƒçš„éƒ¨åˆ†æˆ–è€…å…¨éƒ¨å…ƒç´ å€¼ï¼Œå°±éœ€è¦åˆ—è¡¨è¿­ä»£å™¨æˆ–è€…æ•°ç»„ç´¢å¼•ï¼Œä»¥ä¾¿è®¾ç½®å…ƒç´ çš„å€¼ã€‚ å¹³è¡Œè¿­ä»£ï¼šå¦‚æœéœ€è¦å¹¶è¡Œåœ°éå†å¤šä¸ªé›†åˆï¼Œå°±éœ€è¦æ˜¾å¼åœ°æ§åˆ¶è¿­ä»£å™¨æˆ–è€…ç´¢å¼•å˜é‡ï¼Œä»¥ä¾¿æ‰€æœ‰è¿­ä»£å™¨æˆ–è€…ç´¢å¼•å˜é‡éƒ½å¯ä»¥åŒæ­¥å‰è¿›ï¼ˆå°±å¦‚ä¸Šè¿°æœ‰é—®é¢˜çš„ç‰Œå’Œéª°å­çš„ç¤ºä¾‹ä¸­æ— æ„é—´æ‰€ç¤ºèŒƒçš„é‚£æ ·ï¼‰ For-each æ‹“å±•ä½¿ç”¨ for-each ä¸æ­¢èƒ½éå†é›†åˆå’Œæ•°ç»„ï¼Œè¿˜èƒ½éå†å®ç° Iterable æ¥å£çš„ä»»ä½•å¯¹è±¡ï¼Œåªéœ€è¦å®ç°æ¥å£å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public interface Iterable\u0026lt;T\u0026gt; { /** * Returns an iterator over elements of type {@code T}. * * @return an Iterator. */ Iterator\u0026lt;T\u0026gt; iterator(); default void forEach(Consumer\u0026lt;? super T\u0026gt; action) { Objects.requireNonNull(action); for (T t : this) { action.accept(t); } } } æ¯”å¦‚å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„ LinkedList 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 import java.util.Iterator; import java.util.NoSuchElementException; public class SimpleList\u0026lt;T\u0026gt; implements Iterable\u0026lt;T\u0026gt; { private Node\u0026lt;T\u0026gt; head; private static class Node\u0026lt;T\u0026gt; { T data; Node\u0026lt;T\u0026gt; next; Node(T data) { this.data = data; this.next = null; } } public void add(T data) { if (head == null) { head = new Node\u0026lt;\u0026gt;(data); } else { Node\u0026lt;T\u0026gt; current = head; while (current.next != null) { current = current.next; } current.next = new Node\u0026lt;\u0026gt;(data); } } @Override public Iterator\u0026lt;T\u0026gt; iterator() { return new Iterator\u0026lt;T\u0026gt;() { private Node\u0026lt;T\u0026gt; current = head; @Override public boolean hasNext() { return current != null; } @Override public T next() { if (!hasNext()) { throw new NoSuchElementException(); } T data = current.data; current = current.next; return data; } }; } public static void main(String[] args) { SimpleList\u0026lt;String\u0026gt; list = new SimpleList\u0026lt;\u0026gt;(); list.add(\u0026#34;Hello\u0026#34;); list.add(\u0026#34;World\u0026#34;); list.add(\u0026#34;!\u0026#34;); for (String s : list) { System.out.println(s); } } } æ€»ç»“ æ€»è€Œè¨€ä¹‹ï¼Œä¸ä¼ ç»Ÿçš„ for å¾ªç¯ç›¸æ¯”ï¼Œfor-each å¾ªç¯åœ¨ç®€æ´æ€§ã€çµæ´»æ€§ä»¥åŠå‡ºé”™é¢„é˜²æ€§æ–¹é¢éƒ½å æœ‰ç»å¯¹ä¼˜åŠ¿ï¼Œå¹¶ä¸”æ²¡æœ‰æ€§èƒ½æƒ©ç½šçš„é—®é¢˜ã€‚\nå› æ­¤ï¼Œå½“å¯ä»¥é€‰æ‹©çš„æ—¶å€™ï¼Œfor-each å¾ªç¯åº”è¯¥ä¼˜å…ˆäº for å¾ªç¯ã€‚\n","date":"2021-03-16T10:37:29+08:00","image":"https://capriwits.com/post/java-for_loop_for_each_iterator-efficiency-analysis/java-programming-cover_hu4193375dbb5d85283668ea46b44f9b7a_34987_120x120_fill_box_smart1_3.png","permalink":"https://capriwits.com/post/java-for_loop_for_each_iterator-efficiency-analysis/","title":"Java For-loop For-each Iterator æ•ˆç‡åˆ†æ"},{"content":" Iterator remove æ—¶å‡ºç° ConcurrentModificationException å‰è¨€ åˆ†æ å»ºè®®ç”¨æ³• Iterator remove æ—¶å‡ºç° ConcurrentModificationException å‰è¨€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 import java.util.*; public class Solution { public static void main(String[] args) { List\u0026lt;String\u0026gt; arrayList = new ArrayList\u0026lt;String\u0026gt;(); arrayList.add(\u0026#34;a\u0026#34;); arrayList.add(\u0026#34;b\u0026#34;); arrayList.add(\u0026#34;c\u0026#34;); arrayList.add(\u0026#34;d\u0026#34;); Iterator\u0026lt;String\u0026gt; iterator = arrayList.iterator(); while (iterator.hasNext()) { String cur = iterator.next(); if (\u0026#34;b\u0026#34;.equals(cur)) { arrayList.remove(cur); } else { System.out.println(cur + \u0026#34; \u0026#34;); } } /*for (String s : arrayList) { if (\u0026#34;b\u0026#34;.equals(s)) { arrayList.remove(s); } else { System.out.println(s + \u0026#34; \u0026#34;); } }*/ System.out.println(arrayList); } } for-each å®é™…å°±æ˜¯éšå¼ä½¿ç”¨ iterator éå†é›†åˆï¼Œä¸Šé¢çš„ä¾‹å­ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶åˆ é™¤å¤±è´¥ã€‚ a\nException in thread \u0026ldquo;main\u0026rdquo; java.util.ConcurrentModificationException\nat java.base/java.util.ArrayList$Itr.checkForComodification(ArrayList.java:937)\nat java.base/java.util.ArrayList$Itr.next(ArrayList.java:891)\nat Solution.main(Solution.java:14)\nç„¶è€Œåˆ é™¤ å€’æ•°ç¬¬äºŒä¸ª å…ƒç´ å´ä¸ä¼šæŠ¥é”™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 import java.util.*; public class Solution { public static void main(String[] args) { List\u0026lt;String\u0026gt; arrayList = new ArrayList\u0026lt;\u0026gt;(); arrayList.add(\u0026#34;a\u0026#34;); arrayList.add(\u0026#34;b\u0026#34;); arrayList.add(\u0026#34;c\u0026#34;); arrayList.add(\u0026#34;d\u0026#34;); Iterator\u0026lt;String\u0026gt; iterator = arrayList.iterator(); while (iterator.hasNext()) { String cur = iterator.next(); if (\u0026#34;c\u0026#34;.equals(cur)) { arrayList.remove(cur); } else { System.out.println(cur + \u0026#34; \u0026#34;); } } /*for (String s : arrayList) { if (\u0026#34;c\u0026#34;.equals(s)) { arrayList.remove(s); } else { System.out.println(s + \u0026#34; \u0026#34;); } }*/ System.out.println(arrayList); } } a\nb\n[a, b, d]\nåˆ†æ é¦–å…ˆå…ˆè§‚å¯Ÿ ArrayList çš„ iterator()ï¼Œçœ‹è¿­ä»£å™¨æ€ä¹ˆæ„é€ ã€‚ ArrayList çš„ çˆ¶ç±» AbstractList ä¸­ 1 2 3 public Iterator\u0026lt;E\u0026gt; iterator() { return new Itr(); } Itr æ˜¯é‡Œé¢çš„å†…éƒ¨ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 private class Itr implements Iterator\u0026lt;E\u0026gt; { /** * Index of element to be returned by subsequent call to next. */ int cursor = 0; /** * Index of element returned by most recent call to next or * previous. Reset to -1 if this element is deleted by a call * to remove. */ int lastRet = -1; /** * The modCount value that the iterator believes that the backing * List should have. If this expectation is violated, the iterator * has detected concurrent modification. */ int expectedModCount = modCount; public boolean hasNext() { return cursor != size(); } public E next() { checkForComodification(); try { int i = cursor; E next = get(i); lastRet = i; cursor = i + 1; return next; } catch (IndexOutOfBoundsException e) { checkForComodification(); throw new NoSuchElementException(); } } public void remove() { if (lastRet \u0026lt; 0) throw new IllegalStateException(); checkForComodification(); try { AbstractList.this.remove(lastRet); if (lastRet \u0026lt; cursor) cursor--; lastRet = -1; expectedModCount = modCount; } catch (IndexOutOfBoundsException e) { throw new ConcurrentModificationException(); } } final void checkForComodification() { if (modCount != expectedModCount) throw new ConcurrentModificationException(); } } cursorï¼šä¸‹ä¸€ä¸ªè¦è®¿é—®çš„å…ƒç´ çš„ç´¢å¼• lastRetï¼šä¸Šä¸€ä¸ªè®¿é—®çš„å…ƒç´ çš„ç´¢å¼• expectedModCount æ˜¯æœŸæœ›çš„è¯¥ List è¢«ä¿®æ”¹çš„æ¬¡æ•°ï¼Œåˆå§‹åŒ–ä¸º modCount modCount æ˜¯ AbstractList çš„ä¸€ä¸ªæˆå‘˜å˜é‡ã€‚ The number of times this list has been structurally modified. Structural modifications are those that change the size of the list, or otherwise perturb it in such a fashion that iterations in progress may yield incorrect results.\nThis field is used by the iterator and list iterator implementation returned by the iterator and listIterator methods. If the value of this field changes unexpectedly, the iterator (or list iterator) will throw a ConcurrentModificationException in response to the next, remove, previous, set or add operations. This provides fail-fast behavior, rather than non-deterministic behavior in the face of concurrent modification during iteration.\nUse of this field by subclasses is optional. If a subclass wishes to provide fail-fast iterators (and list iterators), then it merely has to increment this field in its add(int, E) and remove(int) methods (and any other methods that it overrides that result in structural modifications to the list). A single call to add(int, E) or remove(int) must add no more than one to this field, or the iterators (and list iterators) will throw bogus ConcurrentModificationExceptions. If an implementation does not wish to provide fail-fast iterators, this field may be ignored.\n1 protected transient int modCount = 0; ç»“æ„ä¿®æ”¹æ˜¯æŒ‡é‚£äº›æ”¹å˜åˆ—è¡¨å¤§å°çš„ä¿®æ”¹ï¼Œæˆ–è€…ä»¥æŸç§æ–¹å¼æ‰°ä¹±åˆ—è¡¨ï¼Œä½¿å¾—æ­£åœ¨è¿›è¡Œçš„è¿­ä»£å¯èƒ½äº§ç”Ÿä¸æ­£ç¡®çš„ç»“æœã€‚ æ­¤å­—æ®µç”±è¿­ä»£å™¨å’Œ listIteratoræ–¹æ³•è¿”å›çš„è¿­ä»£å™¨å’Œåˆ—è¡¨è¿­ä»£å™¨å®ç°ä½¿ç”¨ã€‚å¦‚æœæ­¤å­—æ®µçš„å€¼æ„å¤–æ›´æ”¹ï¼Œè¿­ä»£å™¨ï¼ˆæˆ–åˆ—è¡¨è¿­ä»£å™¨ï¼‰å°†æŠ›å‡º ConcurrentModificationExceptionä»¥å“åº” nextã€removeã€previousã€set æˆ– add æ“ä½œã€‚è¿™æä¾›äº† å¿«é€Ÿå¤±è´¥ çš„è¡Œä¸ºã€‚ æ·±å…¥ ArrayList é‡Œè§‚å¯Ÿ next() 1 2 3 4 5 6 7 8 9 10 11 public E next() { checkForComodification(); int i = cursor; if (i \u0026gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i \u0026gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; } 1 2 3 4 final void checkForComodification() { if (modCount != expectedModCount) throw new ConcurrentModificationException(); } æŠ›å‡ºçš„ ConcurrentModificationException å¼‚å¸¸æ˜¯ checkForComodification() æŠ›å‡ºçš„ã€‚ æ¡ä»¶æ˜¯ï¼šmodCount != expectedModCount æ‰€ä»¥åœ¨ add remove çš„è¿‡ç¨‹ä¸­ modCount ä¼šè‡ªå¢è‡ªå‡ã€‚å¦‚æœç”¨é›†åˆçš„ removeåˆ™ List çš„ modCountå‡å°‘ä¸€ï¼Œè€Œ Iterator çš„ expectedModCountä¸å˜ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nè‡³äºä¸ºä»€ä¹ˆå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ åˆ é™¤ä¸ä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬è¦å…ˆäº†è§£ Iterator éå†çš„ç‰¹ç‚¹ã€‚\nwhile + iterator çš„ç»„åˆæ˜¯éœ€è¦å…ˆåˆ¤ç©º hasNext()ï¼Œç„¶åå† next()ï¼Œæœ€åæ‰ remove()ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå¯ä»¥è‡ªè¡Œå®éªŒï¼Œè°ƒæ¢ next å’Œ removeã€‚\nå› ä¸ºè¦å…ˆ nextï¼Œå°†æ¸¸æ ‡ è¶Šè¿‡ å½“å‰çš„å…ƒç´ ï¼Œç„¶åå†å†³å®šè¦æ€ä¹ˆæ“ä½œå½“å‰çš„ï¼ˆæ¸¸æ ‡å‰é¢çš„ï¼‰è¿™ä¸ªå…ƒç´ ï¼Œå³æ¸¸æ ‡æ˜¯æ’åœ¨ å½“å‰å…ƒç´  å’Œ ä¸‹ä¸€ä¸ªå…ƒç´  çš„ä¸­é—´ï¼ˆå¯ä»¥è¿™ä¹ˆç†è§£ï¼‰ã€‚\nåˆ é™¤å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œcursor æŒ‡å‘ æœ€åä¸€ä¸ªå…ƒç´ ï¼Œè€Œæ­¤æ—¶åˆ æ‰äº†å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ åï¼Œcursor å’Œ size() æ­£å¥½ç›¸ç­‰äº†ï¼Œæ‰€ä»¥ hasNext() è¿”å› falseï¼Œéå†ç»“æŸï¼ŒæˆåŠŸçš„åˆ é™¤äº†å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ã€‚\nå»ºè®®ç”¨æ³• ä¸€ä¸ªåŸåˆ™æ˜¯ï¼Œå°½é‡åœ¨éå†çš„è¿‡ç¨‹ä¸­ä¸è¦å¯¹åŸé›†åˆè¿›è¡Œå¢åˆ ï¼Œå®¹æ˜“æ”¹å˜åŸç»“æ„ï¼Œå¯ä»¥ç”¨ immutable çš„æ€æƒ³ï¼Œé‡æ–°å°è£…ä¸€ä¸ªé›†åˆã€‚\nè¦ remove() ï¼Œåˆ™è¦åœ¨ iterator() ä¸Šé¢æ¥è¿›è¡Œ remove()ï¼Œå› ä¸º Iterator è¿­ä»£ï¼Œå°±æŠŠæ“ä½œæƒäº¤ç»™äº† Iteratorï¼Œå°±ä¸è¦å†ç”¨åŸé›†åˆè¿›è¡Œæ“ä½œäº†ã€‚\næ­£ç¡®ç”¨æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 import java.util.*; public class Solution { public static void main(String[] args) { List\u0026lt;String\u0026gt; arrayList = new ArrayList\u0026lt;\u0026gt;(); arrayList.add(\u0026#34;a\u0026#34;); arrayList.add(\u0026#34;b\u0026#34;); arrayList.add(\u0026#34;c\u0026#34;); arrayList.add(\u0026#34;d\u0026#34;); Iterator\u0026lt;String\u0026gt; iterator = arrayList.iterator(); while (iterator.hasNext()) { String cur = iterator.next(); if (\u0026#34;a\u0026#34;.equals(cur)) { iterator.remove(); } else { System.out.println(cur + \u0026#34; \u0026#34;); } } System.out.println(arrayList); } } b\nc\nd\n[b, c, d]\nä»¥ä¸Šåˆ†ææ˜¯åŸºäº ArrayListï¼ŒåŸºäºé“¾è¡¨çš„ LinkedList é“ç†å¤§åŒå°å¼‚ï¼Œæ€æƒ³ä¸å˜ï¼Œæµ‹è¯•çš„ç»“æœä¹Ÿæ˜¯ä¸å˜çš„ã€‚\n","date":"2021-03-15T20:10:31+08:00","image":"https://capriwits.com/post/iterator-concurrentmodificationexception-problem-when-remove/java-programming-cover_hu4193375dbb5d85283668ea46b44f9b7a_34987_120x120_fill_box_smart1_3.png","permalink":"https://capriwits.com/post/iterator-concurrentmodificationexception-problem-when-remove/","title":"Iterator remove æ—¶å‡ºç° ConcurrentModificationException"}]